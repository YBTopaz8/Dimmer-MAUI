name: Build & Release Native Clients

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches:
      - Dev-Official
      - master

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write # Needed to upload files to the release

    steps:
      # 1. CHECKOUT MAIN REPO
      - name: Checkout Main Repo
        uses: actions/checkout@v4

      # 2. CHECKOUT DEPENDENCIES
      - name: Checkout Last.fm
        uses: actions/checkout@v4
        with:
          repository: YBTopaz8/Last.fm
          path: ExternalDeps/Last.fm

      - name: Checkout ParseLiveQuery
        uses: actions/checkout@v4
        with:
          repository: YBTopaz8/Parse-LiveQueries-DOTNET
          path: ExternalDeps/Parse-LiveQueries-DOTNET

      - name: Checkout ATL
        uses: actions/checkout@v4
        with:
          repository: Zeugma440/atldotnet
          path: ExternalDeps/atldotnet-main

      - name: Checkout AudioSwitcher
        uses: actions/checkout@v4
        with:
          repository: xenolightning/AudioSwitcher
          path: ExternalDeps/AudioSwitcher-master
          
      # 3. LOCATE PROJECT FILES (Finds the real paths)
      - name: Locate Project Files
        shell: pwsh
        run: |
          # Find the files anywhere in the repo
          $winui = Get-ChildItem -Recurse -Filter "Dimmer.WinUI.csproj" | Select-Object -First 1
          $droid = Get-ChildItem -Recurse -Filter "Dimmer.Droid.csproj" | Select-Object -First 1
          $core  = Get-ChildItem -Recurse -Filter "Dimmer.csproj" | Select-Object -First 1

          if (-not $winui) { Write-Error " Could not find Dimmer.WinUI.csproj"; exit 1 }
          if (-not $droid) { Write-Error " Could not find Dimmer.Droid.csproj"; exit 1 }
          if (-not $core)  { Write-Error " Could not find Dimmer.csproj (Core)"; exit 1 }

          Write-Host " Found WinUI: $($winui.FullName)"
          Write-Host " Found Droid: $($droid.FullName)"
          Write-Host " Found Core:  $($core.FullName)"

          # Save paths to Environment Variables
          echo "PATH_WINUI=$($winui.FullName)" >> $env:GITHUB_ENV
          echo "PATH_DROID=$($droid.FullName)" >> $env:GITHUB_ENV
          echo "DIR_CORE=$($core.Directory.FullName)" >> $env:GITHUB_ENV
          
      # 4. CREATE APPSETTINGS.JSON (Uses detected Core Directory)
      - name: Create appsettings.json
        shell: pwsh
        run: |
          # Use the Core Directory found in the previous step
          $targetPath = Join-Path "${{ env.DIR_CORE }}" "appsettings.json"
          
          # Get the secret content
          $jsonContent = @'
          ${{ secrets.appsettings }}
          '@
          
          # Write to file
          Set-Content -Path $targetPath -Value $jsonContent
          
          if (Test-Path $targetPath) {
              Write-Host "✅ appsettings.json created successfully at $targetPath"
          } else {
              Write-Error "❌ Failed to create appsettings.json"
              exit 1
          }

      # 5. PATCH CSPROJ PATHS 
      - name: Fix Dependency Paths
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object {
            $content = Get-Content $_.FullName
            $content = $content -replace '(\.\.\\)+Last.fm', '..\ExternalDeps\Last.fm'
            $content = $content -replace '(\.\.\\)+Parse-LiveQueries-DOTNET', '..\ExternalDeps\Parse-LiveQueries-DOTNET'
            $content = $content -replace '(\.\.\\)+atldotnet-main', '..\ExternalDeps\atldotnet-main'
            $content = $content -replace '(\.\.\\)+AudioSwitcher-master', '..\ExternalDeps\AudioSwitcher-master'
            Set-Content $_.FullName $content
          }

      # 6. SETUP .NET
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install MAUI Workloads
        run: dotnet workload install maui-android maui-windows

      # 7. BUILD WINDOWS (Uses env.PATH_WINUI)
      - name: Build Windows
        run: |
          dotnet publish "${{ env.PATH_WINUI }}" `
            -f net9.0-windows10.0.19041.0 `
            -c Release `
            -r win-x64 `
            -p:WindowsPackageType=None `
            -p:GenerateAppxPackageOnBuild=false `
            -p:AppxPackageSigningEnabled=false `
            -p:EnableMrtResourceGeneration=false `
            --self-contained=false `
            -o .\RawBuild\WinUI

      # 8. ZIP WINDOWS (From RawBuild to Artifacts)
      - name: Zip Windows Build
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path .\Artifacts
          Compress-Archive -Path .\RawBuild\WinUI\* -DestinationPath .\Artifacts\Dimmer-Win-x64.zip

      # 9. BUILD ANDROID (Uses env.PATH_DROID)
      - name: Build Android
        run: |
          dotnet publish "${{ env.PATH_DROID }}" `
            -f net9.0-android `
            -c Release `
            -r android-arm64 `
            -p:AndroidPackageFormat=apk `
            -o .\RawBuild\Android

      # 10. UPLOAD TO RELEASE
      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            .\RawBuild\Android\*.apk
            .\Artifacts\Dimmer-Win-x64.zip

      # 11. NOTIFY DISCORD
      - name: Notify Discord
        uses: Ilshidur/action-discord@master
        if: always() # Runs even if build fails, so you know why
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            Build Status: **${{ job.status }}**
            Version: ${{ github.event.release.tag_name || 'Manual/Push' }}
            
            [View Run Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
