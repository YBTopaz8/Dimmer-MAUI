name: Build & Release Native Clients

on:
  workflow_dispatch:
  push:
    branches:
      - releaseBranch

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write # REQUIRED for pushing tags

    steps:
      # 1. CHECKOUT
      - name: Checkout Main Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. CACHE NUGET
      - name: Cache NuGet Packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

          
# 3. DETECT VERSION CHANGE TYPE (FIXED)
      - name: Detect Version & Release Type
        id: version_logic
        shell: pwsh
        run: |
          # --- A. READ CURRENT VERSION FROM FILE ---
          $projectFile = Get-ChildItem -Recurse -Filter "Dimmer.csproj" | Select-Object -First 1
          if (-not $projectFile) { Write-Error "‚ùå Dimmer.csproj not found"; exit 1 }
          
          [xml]$xml = Get-Content $projectFile.FullName
          $currentVersionStr = $xml.Project.PropertyGroup.Version.Trim()
          
          if ([string]::IsNullOrWhiteSpace($currentVersionStr)) {
            Write-Error "‚ùå No <Version> tag found in Dimmer.csproj."
            exit 1
          }
          
          $newTag = "v$currentVersionStr"
          Write-Host "üîπ Current File Version: $currentVersionStr"
          echo "NEW_TAG=$newTag" >> $env:GITHUB_ENV
          
          # --- B. FIND PREVIOUS TAG ---
          git fetch --tags --force
          
          # Get all tags
          $allTags = git tag --sort=-version:refname 
          
          # Filter: Exclude current tag AND ensure tag looks like a standard version (e.g. v1.0, 1.0.5)
          # This ignores tags like "v1.92a" which cause the crash
          $validPattern = "^v?\d+(\.\d+)+$"
          $prevTag = $allTags | Where-Object { $_.Trim() -ne $newTag -and $_.Trim() -match $validPattern } | Select-Object -First 1
          
          if ([string]::IsNullOrWhiteSpace($prevTag)) {
            Write-Host "‚ö†Ô∏è No previous standard tag found. Treating as first STABLE release."
            echo "IS_PRE=false" >> $env:GITHUB_ENV
            echo "LATEST_TAG=" >> $env:GITHUB_ENV
          } else {
            Write-Host "üîπ Previous Valid Tag found: $prevTag"
            echo "LATEST_TAG=$prevTag" >> $env:GITHUB_ENV
          }
          
          # --- C. COMPARE VERSIONS ---
          if ($prevTag) {
            # Sanitize: Remove 'v' and anything that isn't a number or dot
            $prevVersionStr = $prevTag -replace "[^0-9\.]", ""
            
            try {
              $curV = [System.Version]$currentVersionStr
              $prevV = [System.Version]$prevVersionStr
              
              Write-Host "Comparing $curV vs $prevV"
              
              if ($curV.Major -gt $prevV.Major -or $curV.Minor -gt $prevV.Minor) {
                  Write-Host "üöÄ Major/Minor change. Marking as STABLE RELEASE."
                  echo "IS_PRE=false" >> $env:GITHUB_ENV
              } else {
                  Write-Host "üß™ Patch change. Marking as PRE-RELEASE."
                  echo "IS_PRE=true" >> $env:GITHUB_ENV
              }
            } catch {
              Write-Warning "Could not parse versions despite sanitization. Defaulting to Pre-Release."
              echo "IS_PRE=true" >> $env:GITHUB_ENV
            }
          }

      # 3.5 GENERATE CHANGELOG (FIXED with Fallback)
      - name: Generate Changelog
        shell: pwsh
        run: |
          $prevTag = $env:LATEST_TAG
          $newTag = $env:NEW_TAG
          
          Write-Host "Generating log from '$prevTag' to 'HEAD'"

          # 1. Try Standard Range Log
          if ([string]::IsNullOrEmpty($prevTag)) {
              $log = git log --pretty=format:"- %s (%h)" --no-merges
          } else {
              $log = git log $prevTag..HEAD --pretty=format:"- %s (%h)" --no-merges
          }

          # Convert array to string if necessary
          if ($log -is [Array]) { $logString = $log -join "`n" } else { $logString = $log }

          # 2. Fallback: If empty, grab last 15 commits (Ensures no empty release notes)
          if ([string]::IsNullOrWhiteSpace($logString)) { 
             Write-Warning "Standard log range was empty. Falling back to last 15 commits."
             $log = git log -n 15 --pretty=format:"- %s (%h)" --no-merges
             if ($log -is [Array]) { $logString = $log -join "`n" } else { $logString = $log }
          }

          # 3. Final Check
          if ([string]::IsNullOrWhiteSpace($logString)) { 
            $logString = "- No commit messages found (Manual Check Recommended)." 
          }

          $content = "## Changes in $newTag`n`n$logString"
          Set-Content -Path "release_notes.md" -Value $content -Encoding UTF8
          
          Write-Host "--- RELEASE NOTES PREVIEW ---"
          Write-Host $content
          Write-Host "-----------------------------"

      # 4. CHECKOUT DEPENDENCIES
      - name: Checkout Last.fm
        uses: actions/checkout@v4
        with:
          repository: YBTopaz8/Last.fm
          path: ExternalDeps/Last.fm

      - name: Checkout ParseLiveQuery
        uses: actions/checkout@v4
        with:
          repository: YBTopaz8/Parse-LiveQueries-DOTNET
          path: ExternalDeps/Parse-LiveQueries-DOTNET

      - name: Checkout ATL
        uses: actions/checkout@v4
        with:
          repository: Zeugma440/atldotnet
          path: ExternalDeps/atldotnet-main

      - name: Checkout AudioSwitcher
        uses: actions/checkout@v4
        with:
          repository: xenolightning/AudioSwitcher
          path: ExternalDeps/AudioSwitcher-master
          
      # 5. LOCATE PROJECT FILES
      - name: Locate Project Files
        shell: pwsh
        run: |
          $winui = Get-ChildItem -Recurse -Filter "Dimmer.WinUI.csproj" | Select-Object -First 1
          $droid = Get-ChildItem -Recurse -Filter "Dimmer.Droid.csproj" | Select-Object -First 1
          $core  = Get-ChildItem -Recurse -Filter "Dimmer.csproj" | Select-Object -First 1

          if (-not $winui) { Write-Error "‚ùå Missing Dimmer.WinUI.csproj"; exit 1 }
          if (-not $droid) { Write-Error "‚ùå Missing Dimmer.Droid.csproj"; exit 1 }
          if (-not $core)  { Write-Error "‚ùå Missing Dimmer.csproj"; exit 1 }

          echo "PATH_WINUI=$($winui.FullName)" >> $env:GITHUB_ENV
          echo "PATH_DROID=$($droid.FullName)" >> $env:GITHUB_ENV
          echo "DIR_CORE=$($core.Directory.FullName)" >> $env:GITHUB_ENV
          
      # 6. CREATE APPSETTINGS.JSON
      - name: Create appsettings.json
        shell: pwsh
        run: |
          $targetPath = Join-Path "${{ env.DIR_CORE }}" "appsettings.json"
          $jsonContent = @'
          ${{ secrets.appsettings }}
          '@
          Set-Content -Path $targetPath -Value $jsonContent -Encoding UTF8

      # 7. PATCH CSPROJ PATHS (FIXED: Handles -master folders and slashes)
      - name: Fix Dependency Paths
        shell: pwsh
        run: |
          $depsPath = Join-Path $env:GITHUB_WORKSPACE "ExternalDeps"
          
          # Match ".." followed by slash or backslash, repeated
          $relPattern = '(\.\.[\\/])+' 
          
          Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object {
            $content = Get-Content $_.FullName
            
            # 1. Last.fm: In csproj it is "Last.fm-master" -> We map to checkout folder "Last.fm"
            $content = $content -replace "${relPattern}Last\.fm-master", "$depsPath\Last.fm"

            # 2. Parse: In csproj it is "Parse-LiveQueries-DOTNET-master" -> Map to "Parse-LiveQueries-DOTNET"
            $content = $content -replace "${relPattern}Parse-LiveQueries-DOTNET-master", "$depsPath\Parse-LiveQueries-DOTNET"

            # 3. ATL: In csproj it is "atldotnet-main" -> Map to "atldotnet-main"
            $content = $content -replace "${relPattern}atldotnet-main", "$depsPath\atldotnet-main"

            # 4. AudioSwitcher: In csproj it is "AudioSwitcher-master" -> Map to "AudioSwitcher-master"
            $content = $content -replace "${relPattern}AudioSwitcher-master", "$depsPath\AudioSwitcher-master"

            Set-Content $_.FullName $content -Encoding UTF8
          }
          
          # Debug: Prove it worked
          Select-String -Path "${{ env.DIR_CORE }}\Dimmer.csproj" -Pattern "ProjectReference"

      # 8. SETUP .NET & WORKLOADS
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install MAUI Workloads
        run: dotnet workload install maui-android maui-windows

      - name: Disable AudioSwitcher Signing
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -Filter "AudioSwitcher*.csproj" | ForEach-Object {
            $content = Get-Content $_.FullName
            $content = $content -replace '<AssemblyOriginatorKeyFile>.*?</AssemblyOriginatorKeyFile>', ''
            $content = $content -replace '<SignAssembly>true</SignAssembly>', '<SignAssembly>false</SignAssembly>'
            Set-Content $_.FullName $content -Encoding UTF8
          }

      # 9. BUILD WINDOWS
      - name: Build Windows
        run: |
          dotnet publish "${{ env.PATH_WINUI }}" `
            -f net9.0-windows10.0.19041.0 `
            -c Release `
            -r win-x64 `
            -p:WindowsPackageType=None `
            -p:GenerateAppxPackageOnBuild=false `
            -p:AppxPackageSigningEnabled=false `
            -p:EnableMrtResourceGeneration=false `
            --self-contained=false `
            -o .\RawBuild\WinUI

      # 10. ZIP WINDOWS
      - name: Zip Windows Build
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path .\Artifacts
          Compress-Archive -Path .\RawBuild\WinUI\* -DestinationPath .\Artifacts\Dimmer-Windows-Portable-${{ env.NEW_TAG }}.zip

      # 11. BUILD ANDROID
      - name: Build Android
        run: |
          dotnet publish "${{ env.PATH_DROID }}" `
            -f net9.0-android `
            -c Release `
            -r android-arm64 `
            -p:AndroidPackageFormat=apk `
            -o .\RawBuild\Android
      
      # 12. UPLOAD ARTIFACTS
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Dimmer-Builds-${{ env.NEW_TAG }}
          path: |
            RawBuild/Android/*.apk
            Artifacts/Dimmer-Windows-Portable-${{ env.NEW_TAG }}.zip
            
      # 13. PUSH TAG & RELEASE
      - name: Push Tag & Create Release
        uses: softprops/action-gh-release@v1        
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: Release ${{ env.NEW_TAG }}
          draft: false
          prerelease: ${{ env.IS_PRE }}
          body_path: release_notes.md
          files: |
            RawBuild/Android/*.apk
            Artifacts/Dimmer-Windows-Portable-${{ env.NEW_TAG }}.zip
      
      # 14. NOTIFY DISCORD
      - name: Notify Discord
        if: always()
        shell: pwsh
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if (-not $env:DISCORD_WEBHOOK) { Write-Host "No Webhook found"; exit 0 }
          
          $status = "${{ job.status }}"
          $branch = "${{ github.ref_name }}"
          
          if ($status -eq 'success') { 
              $title = "Dimmer Release: ${{ env.NEW_TAG }}"
              $color = 3066993 # Green
              if ("${{ env.IS_PRE }}" -eq "true") { 
                $title = "Dimmer Pre-Release: ${{ env.NEW_TAG }}" 
                $color = 16776960 # Yellow
              }
          } else { 
              $title = "‚ùå Dimmer Build Failed"
              $color = 15158332 # Red
          }

          $body = @{
            embeds = @(
              @{
                title = $title
                description = "Status: $status`nBranch: $branch"
                color = $color
                fields = @(
                  @{ name = "View Release on GitHub"; value = "[Click Here](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.NEW_TAG }})" }
                )
              }
            )
          } | ConvertTo-Json -Depth 4
          
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType 'application/json' -Body $body
