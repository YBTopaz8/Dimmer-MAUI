name: Build & Release Native Dimmer Clients

on:
  workflow_dispatch:
  push:
    branches:
      - releaseBranch

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      # 1. CHECKOUT
      - name: Checkout Main Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. CACHE NUGET
      - name: Cache NuGet Packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # 3. DETECT VERSION & RELEASE TYPE
      - name: Detect Version & Release Type
        id: version_logic
        shell: pwsh
        run: |
          $projectFile = Get-ChildItem -Recurse -Filter "Dimmer.csproj" | Select-Object -First 1
          [xml]$xml = Get-Content $projectFile.FullName
          $currentVersionStr = $xml.Project.PropertyGroup.Version.Trim()
          $newTag = "v$currentVersionStr"
          "NEW_TAG=$newTag" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          
          git fetch --tags --force
          $allTags = git tag --sort=-version:refname 
          $validPattern = "^v?\d+(\.\d+)+$"
          $foundTag = $allTags | Where-Object { $_.Trim() -ne $newTag -and $_.Trim() -match $validPattern } | Select-Object -First 1
          
          if ($null -ne $foundTag) {
              $prevTag = $foundTag.Trim()
              "LATEST_TAG=$prevTag" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
              $curV = [System.Version]$currentVersionStr
              $prevV = [System.Version]($prevTag -replace "[^0-9\.]", "")
              if ($curV.Major -gt $prevV.Major -or $curV.Minor -gt $prevV.Minor) { "IS_PRE=false" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8 }
              else { "IS_PRE=true" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8 }
          } else {
              "IS_PRE=false" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
              "LATEST_TAG=" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }

      # 3.5 GENERATE CHANGELOG
      - name: Generate Changelog
        shell: pwsh
        run: |
          $prevTag = $env:LATEST_TAG
          if ([string]::IsNullOrWhiteSpace($prevTag)) {
              $log = git log --pretty=format:"- %s (%h)" --no-merges
          } else {
              $log = git log "$($prevTag)..HEAD" --pretty=format:"- %s (%h)" --no-merges
          }
          $logString = if ($log -is [Array]) { $log -join "`n" } else { $log }
          if ([string]::IsNullOrWhiteSpace($logString)) { $logString = git log -n 15 --pretty=format:"- %s (%h)" --no-merges -join "`n" }
          $content = "## Changes in $env:NEW_TAG`n`n$logString"
          Set-Content -Path "release_notes.md" -Value $content -Encoding UTF8
          $escapedLog = $logString -replace '"', '\"' -replace "`n", "\n" -replace "`r", ""
          "ESCAPED_LOG=$escapedLog" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      # 4. CHECKOUT DEPENDENCIES
      - name: Checkout Dependencies
        shell: pwsh
        run: |
          git clone https://github.com/YBTopaz8/Last.fm "$env:GITHUB_WORKSPACE\ExternalDeps\Last.fm"
          git clone https://github.com/YBTopaz8/Parse-LiveQueries-DOTNET "$env:GITHUB_WORKSPACE\ExternalDeps\Parse-LiveQueries-DOTNET"
          git clone https://github.com/Zeugma440/atldotnet "$env:GITHUB_WORKSPACE\ExternalDeps\atldotnet-main"
          git clone https://github.com/xenolightning/AudioSwitcher "$env:GITHUB_WORKSPACE\ExternalDeps\AudioSwitcher-master"

      # 5. LOCATE PROJECT FILES
      - name: Locate Project Files
        shell: pwsh
        run: |
          $winui = Get-ChildItem -Recurse -Filter "Dimmer.WinUI.csproj" | Select-Object -First 1
          $droid = Get-ChildItem -Recurse -Filter "Dimmer.Droid.csproj" | Select-Object -First 1
          $core  = Get-ChildItem -Recurse -Filter "Dimmer.csproj" | Select-Object -First 1
          echo "PATH_WINUI=$($winui.FullName)" >> $env:GITHUB_ENV
          echo "PATH_DROID=$($droid.FullName)" >> $env:GITHUB_ENV
          echo "DIR_CORE=$($core.Directory.FullName)" >> $env:GITHUB_ENV
          
      # 6. CREATE APPSETTINGS.JSON
      - name: Create appsettings.json
        shell: pwsh
        run: |
          $targetPath = Join-Path "${{ env.DIR_CORE }}" "appsettings.json"
          Set-Content -Path $targetPath -Value '${{ secrets.appsettings }}' -Encoding UTF8

      # 7. PATCH CSPROJ PATHS
      - name: Fix Dependency Paths
        shell: pwsh
        run: |
          $depsRoot = "$env:GITHUB_WORKSPACE\ExternalDeps"
          $mappings = @{
            "Last.fm\src\Hqub.Lastfm\Hqub.Lastfm.csproj" = "$depsRoot\Last.fm\src\Hqub.Lastfm\Hqub.Lastfm.csproj"
            "Parse-LiveQueries-DOTNET\ParseLiveQuery\ParseLiveQuery.csproj" = "$depsRoot\Parse-LiveQueries-DOTNET\ParseLiveQuery\ParseLiveQuery.csproj"
            "atldotnet-main\ATL\ATL.csproj" = "$depsRoot\atldotnet-main\ATL\ATL.csproj"
            "AudioSwitcher-master\AudioSwitcher.AudioApi.CoreAudio\AudioSwitcher.AudioApi.CoreAudio.csproj" = "$depsRoot\AudioSwitcher-master\AudioSwitcher.AudioApi.CoreAudio\AudioSwitcher.AudioApi.CoreAudio.csproj"
            "AudioSwitcher-master\AudioSwitcher.AudioApi\AudioSwitcher.AudioApi.csproj" = "$depsRoot\AudioSwitcher-master\AudioSwitcher.AudioApi\AudioSwitcher.AudioApi.csproj"
          }
          Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object {
            $path = $_.FullName
            $content = Get-Content $path -Raw
            $changed = $false
            foreach ($key in $mappings.Keys) {
              $pattern = 'Include=".*' + [Regex]::Escape($key) + '"'
              $replacement = 'Include="' + $mappings[$key] + '"'
              if ($content -match $pattern) { $content = $content -replace $pattern, $replacement; $changed = $true }
            }
            if ($changed) { Set-Content $path $content -Encoding UTF8 }
          }

      # 8. DISABLE EXTERNAL REPO SIGNING (FIXES PFX ERROR)
      - name: Disable AudioSwitcher Signing
        shell: pwsh
        run: |
          $audioPath = Join-Path $env:GITHUB_WORKSPACE "ExternalDeps\AudioSwitcher-master"
          Get-ChildItem -Path $audioPath -Recurse -Filter "*.csproj" | ForEach-Object {
            Write-Host "Disabling signing for: $($_.Name)"
            $content = Get-Content $_.FullName -Raw
            # Strip AssemblyOriginatorKeyFile tags and set SignAssembly to false
            $content = $content -replace '<AssemblyOriginatorKeyFile>.*?</AssemblyOriginatorKeyFile>', ''
            $content = $content -replace '<SignAssembly>true</SignAssembly>', '<SignAssembly>false</SignAssembly>'
            Set-Content $_.FullName $content -Encoding UTF8
          }

      # 9. SETUP .NET & WORKLOADS
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install MAUI Workloads
        run: dotnet workload install maui-android maui-windows

      # 10. BUILD WINDOWS
      - name: Build Windows
        run: |
          dotnet publish "${{ env.PATH_WINUI }}" -f net9.0-windows10.0.19041.0 -c Release -r win-x64 -p:WindowsPackageType=None -p:GenerateAppxPackageOnBuild=false -p:AppxPackageSigningEnabled=false -o .\RawBuild\WinUI

      # 11. ZIP WINDOWS
      - name: Zip Windows Build
        shell: pwsh
        run: |
          $zipPath = ".\Artifacts\Dimmer-Windows-Portable-${{ env.NEW_TAG }}.zip"
          New-Item -ItemType Directory -Force -Path .\Artifacts
          Compress-Archive -Path .\RawBuild\WinUI\* -DestinationPath $zipPath
          $size = (Get-Item $zipPath).Length
          echo "WIN_SIZE=$size" >> $env:GITHUB_ENV

      # 12. BUILD ANDROID
      - name: Build Android
        run: |
          dotnet publish "${{ env.PATH_DROID }}" -f net9.0-android -c Release -r android-arm64 -p:AndroidPackageFormat=apk -o .\RawBuild\Android
      
      - name: Get Android Size
        shell: pwsh
        run: |
          $apk = Get-ChildItem ".\RawBuild\Android\*-Signed.apk" | Select-Object -First 1
          echo "APK_SIZE=$($apk.Length)" >> $env:GITHUB_ENV

      # 13. UPLOAD ARTIFACTS
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Dimmer-Builds-${{ env.NEW_TAG }}
          path: |
            RawBuild/Android/*.apk
            Artifacts/Dimmer-Windows-Portable-${{ env.NEW_TAG }}.zip
            
      # 14. PUSH TAG & RELEASE
      - name: Push Tag & Create Release
        id: create_release
        uses: softprops/action-gh-release@v1        
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: Release ${{ env.NEW_TAG }}
          draft: false
          prerelease: ${{ env.IS_PRE }}
          body_path: release_notes.md
          files: |
            RawBuild/Android/*.apk
            Artifacts/Dimmer-Windows-Portable-${{ env.NEW_TAG }}.zip

      # 15. NOTIFY PARSE SERVER (postAppUpdate)
      - name: Notify Parse of New Update
        shell: pwsh
        env:
          PARSE_APP_ID: ${{ secrets.PARSE_APP_ID }}
          PARSE_MASTER_KEY: ${{ secrets.PARSE_MASTER_KEY }}
          PARSE_SERVER_URL: ${{ secrets.PARSE_SERVER_URL }}
        run: |
          $releaseUrl = "${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.NEW_TAG }}"
          $title = "Dimmer ${{ env.NEW_TAG }}"
          $notes = "Android Size: $([math]::Round($env:APK_SIZE / 1MB, 2))MB`nWindows Size: $([math]::Round($env:WIN_SIZE / 1MB, 2))MB`n`n${{ env.ESCAPED_LOG }}"
          $body = @{ title = $title; notes = $notes; url = $releaseUrl } | ConvertTo-Json
          $headers = @{ "X-Parse-Application-Id" = $env:PARSE_APP_ID; "X-Parse-Master-Key" = $env:PARSE_MASTER_KEY; "Content-Type" = "application/json" }
          Invoke-RestMethod -Uri "$($env:PARSE_SERVER_URL)/functions/postAppUpdate" -Method Post -Headers $headers -Body $body

      # 16. NOTIFY DISCORD
      - name: Notify Discord
        if: always()
        shell: pwsh
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if (-not $env:DISCORD_WEBHOOK) { exit 0 }
          $status = "${{ job.status }}"
          $color = if ($status -eq 'success') { 3066993 } else { 15158332 }
          $body = @{ embeds = @(@{ title = "Dimmer Release: ${{ env.NEW_TAG }}"; description = "Status: $status"; color = $color; fields = @(@{ name = "Release"; value = "[View](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.NEW_TAG }})" }) }) } | ConvertTo-Json -Depth 4
          Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType 'application/json' -Body $body
