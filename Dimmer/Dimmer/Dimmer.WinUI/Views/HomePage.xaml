<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Dimmer.WinUI.Views.HomePage"
             xmlns:vmm="clr-namespace:Dimmer.WinUI.ViewModel"
             
             x:DataType="vmm:BaseViewModelWin"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
            xmlns:converters="clr-namespace:Dimmer.Utilities.TypeConverters;assembly=Dimmer"
             xmlns:syncf="http://schemas.syncfusion.com/maui/toolkit" 
             xmlns:models ="clr-namespace:Dimmer.Database.ModelView;assembly=Dimmer"
             x:Name="myPage"
             xmlns:cw="clr-namespace:Dimmer.WinUI.Views.CustomViews"
             Title="HomePage">

    <ContentPage.Resources>
        <converters:DurationConverterFromMsToTimeSpan x:Key="DurationConverter"/>
        <converters:BytesToMegabytesConverter x:Key="FileSizeConverter"/>
        <converters:BytesArrayToImageSource x:Key="BytesToImageConverter"/>
        <converters:BoolToInverseConverter x:Key="BoolToInverse"/>
        <converters:IndexToVisibilityConverter x:Key="IndexToVisibilityConverter"/>
        <converters:DateTimeToLocalDateConverter x:Key="DateTimeConverter"/>
        <converters:DateTimeToLocalTimeConverter x:Key="DateTimeToTimeConverter"/>
        <converters:BoolToYesNoConverter x:Key="BoolToYesNo"/>
        <converters:VolumeConverter x:Key="VolConverter" />

    </ContentPage.Resources>
    <Shell.TitleView>

        <Grid ColumnDefinitions="550,*" Grid.Row="0" 
                      Margin="15,0" x:Name="BmtBarView">
            <Grid.GestureRecognizers>
                <PointerGestureRecognizer x:Name="BtmBarPointerGest" PointerEntered="BtmBarPointerGest_PointerEntered"
                                              PointerExited="BtmBarPointerGest_PointerExited" />

            </Grid.GestureRecognizers>

            <HorizontalStackLayout Grid.Row="0" Grid.Column="0">
                <syncf:SfChipGroup ChipType="Action" 
                                       x:Name="MediaChipBtn"
                                       ChipClicked="MediaChipBtn_ChipClicked" 
                                       HorizontalOptions="Center" SelectionIndicatorColor="DarkSlateBlue"
                                       >
                    <syncf:SfChipGroup.Resources>
                        <ResourceDictionary>
                            <Style TargetType="syncf:SfChip">
                                <Setter Property="ShowIcon" Value="True"/>
                                <Setter Property="StrokeThickness" Value="0"/>
                                <Setter Property="ImageSize" Value="30"/>
                                
                            </Style>
                        </ResourceDictionary>
                    </syncf:SfChipGroup.Resources>
                    <syncf:SfChipGroup.ChipLayout>
                        <HorizontalStackLayout Spacing="10" 
                                     HorizontalOptions="Start"/>
                    </syncf:SfChipGroup.ChipLayout>
                    <syncf:SfChipGroup.Items>

                        <syncf:SfChip HorizontalOptions="Center"
                                          CommandParameter="0" >

                            <syncf:SfChip.Triggers>

                                <DataTrigger TargetType="syncf:SfChip" Value="0" Binding="{Binding RepeatMode}">

                                    <Setter Property="ImageSource" Value="repoff.png" />
                                </DataTrigger>

                                <DataTrigger TargetType="syncf:SfChip" Value="1" Binding="{Binding RepeatMode}">

                                    <Setter Property="ImageSource" Value="repeat.png"/>
                                </DataTrigger>

                                <DataTrigger TargetType="syncf:SfChip" Value="2" Binding="{Binding RepeatMode}">

                                    <Setter Property="ImageSource" Value="repone.png"/>
                                </DataTrigger>

                                <DataTrigger TargetType="syncf:SfChip" Value="4" Binding="{Binding RepeatMode}">
                                    <Setter Property="ImageSource" Value="repone.png"/>
                                </DataTrigger>
                            </syncf:SfChip.Triggers>
                        </syncf:SfChip>


                        <syncf:SfChip ImageSource="skipprevious.png" 
                                      CommandParameter="1" TextColor="White"/>

                        <syncf:SfChip ImageSource="pause.png" 
                                      CommandParameter="2" TextColor="White"/>

                        <syncf:SfChip ImageSource="playcircle.png" IsVisible="{Binding IsPlaying, Converter={x:StaticResource BoolToInverse}}"
                                      CommandParameter="3" TextColor="White"/>

                        <syncf:SfChip ImageSource="skipnext.png" 
                                      CommandParameter="4" TextColor="White"/>
                        <syncf:SfChip ImageSource="shuffle.png" 
                                      CommandParameter="5" TextColor="White">

                            <syncf:SfChip.Triggers>

                                <DataTrigger TargetType="syncf:SfChip" Value="True" Binding="{Binding IsShuffle}">

                                    <Setter Property="BackgroundColor" Value="#B197FC"/>
                                </DataTrigger>

                                <DataTrigger TargetType="syncf:SfChip" Value="False" Binding="{Binding IsPlaying}">

                                    <Setter Property="BackgroundColor" Value="Transparent"/>
                                </DataTrigger>

                            </syncf:SfChip.Triggers>
                        </syncf:SfChip>

                    </syncf:SfChipGroup.Items>
                </syncf:SfChipGroup>


                <syncf:SfEffectsView  BackgroundColor="Transparent" WidthRequest="100"
                                     Loaded="SfEffectsView_Loaded" Grid.Column="2"
                                     Unloaded="SfEffectsView_Unloaded">
                    <VerticalStackLayout VerticalOptions="Center" >
                        <Label  HorizontalOptions="Center"/>

                        <Slider  VerticalOptions="End" Value="{Binding VolumeLevel}"
                                Maximum="1" Minimum="0" x:Name="VolumeSlider" WidthRequest="100"
                                 ValueChanged="VolumeSlider_ValueChanged"
                                MinimumTrackColor="DarkSlateBlue" />
                    </VerticalStackLayout>
                </syncf:SfEffectsView>
            </HorizontalStackLayout>

            <Grid ColumnDefinitions="auto,*,auto"
                          ColumnSpacing="5" Grid.Column="1">

                <Label Grid.Column="0"
                        Text="{Binding CurrentPositionInSeconds, Converter={StaticResource DurationConverter}}"
                           HorizontalOptions="Center" FontSize="16" 
                           Margin="0,5,0,0"/>
                <Slider Grid.Column="1" DragCompleted="CurrentPositionSlider_DragCompleted"
                            x:Name="CurrentPositionSlider" MinimumTrackColor="DarkSlateBlue"
                            VerticalOptions="Center" ThumbColor="AliceBlue"
                            Value="{Binding CurrentPositionInSeconds}"
            Minimum="0" Maximum="{Binding TemporarilyPickedSong.DurationInSeconds}"/>

                <Label Text="{Binding TemporarilyPickedSong.DurationInSeconds, Converter={StaticResource DurationConverter}}"
                           HorizontalOptions="Center" FontSize="16" Grid.Column="2"
                           Margin="0,5,0,0"/>
            </Grid>
        </Grid>

    </Shell.TitleView>
    <Grid x:Name="MainPage" Margin="10,5">
        
        <Image Source="{Binding TemporarilyPickedSong.CoverImagePath}"
               Aspect="AspectFit" Opacity="0.06"/>
        <Grid  ColumnDefinitions="200,*">
            <VerticalStackLayout Grid.Column="0">
                <Border StrokeShape="RoundRectangle 20">
                    <Image Source="{Binding TemporarilyPickedSong.CoverImagePath}"
                       Aspect="AspectFit" WidthRequest="200"
                       HeightRequest="200">

                    </Image>
                </Border>
                <syncf:SfChipGroup ChipType="Action" 
                              x:Name="TempSongChipGroup"
                              ChipClicked="TempSongChipGroup_ChipClicked" 
                              HorizontalOptions="Center" SelectionIndicatorColor="DarkSlateBlue"
                              >
                    <syncf:SfChipGroup.Resources>
                        <ResourceDictionary>
                            <Style TargetType="syncf:SfChip">
                                <Setter Property="ShowIcon" Value="True"/>
                                <Setter Property="StrokeThickness" Value="0"/>
                                <Setter Property="ImageSize" Value="20"/>
                                
                                
                            </Style>
                        </ResourceDictionary>
                    </syncf:SfChipGroup.Resources>
                    <syncf:SfChipGroup.ChipLayout>
                        <VerticalStackLayout Spacing="10" 
                            HorizontalOptions="Start"/>
                    </syncf:SfChipGroup.ChipLayout>
                    <syncf:SfChipGroup.Items>


                        <syncf:SfChip ImageSource="songc.png" Text="{Binding TemporarilyPickedSong.Title}"
                             CommandParameter="0"
                                      FontAttributes="Bold" FontSize="20"
                                      TextColor="White"/>

                        <syncf:SfChip ImageSource="artist.png"  Text="{Binding TemporarilyPickedSong.ArtistName}"
                             CommandParameter="1" TextColor="White"
                                      FontSize="14"
                                      FontAttributes="Italic"/>

                        <syncf:SfChip ImageSource="vinyl.png"                                      
                                      FontAttributes="Italic"
                                      FontSize="11"
                             CommandParameter="2" TextColor="White" Text="{Binding TemporarilyPickedSong.AlbumName}"/>

                        <syncf:SfChip ImageSource="lyrics.png" IsVisible="{Binding TemporarilyPickedSong.HasLyrics}"
                             CommandParameter="4" TextColor="White" />

                    </syncf:SfChipGroup.Items>
                </syncf:SfChipGroup>


            </VerticalStackLayout>
            <Grid Grid.Column="1" RowDefinitions="*,100">
                <HorizontalStackLayout 
                                   Grid.Row="1"
                                   HorizontalOptions="End">

                    <SearchBar Text="{Binding SearchText}" BackgroundColor="Transparent"                           
                               x:Name="SearchSongSB" HeightRequest="30" Placeholder="Search Title, Artist, Album..."
                               WidthRequest="500" TextChanged="SearchSongSB_TextChanged">

                    </SearchBar>
                    <Button Text="testbtn" Clicked="Button_Clicked" VerticalOptions="Center"/>
                    <Button Text="testbtn2" Clicked="Button2_Clicked" VerticalOptions="Center"/>
                </HorizontalStackLayout>
                <CollectionView Grid.Row="0"
                BackgroundColor="Transparent" ItemsSource="{Binding MasterSongs}"
                            VerticalScrollBarVisibility="Default"
                            x:Name="SongsColView" 
                            Margin="5,0">

                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center">
                            <Label Text="No Songs Found, Please Scan Songs In Settings Tab "
                            HorizontalOptions="Center"
                            FontSize="16"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="3"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:SongModelView">
                            <Border BackgroundColor="Transparent" Padding="2"
                                        StrokeShape="RoundRectangle 12">

                                <syncf:SfEffectsView ToolTipProperties.Text="{Binding Title}"       
                                                 BackgroundColor="Transparent"                                     
                                             
                                                TouchDownEffects="Ripple,Selection" >
                                    <Grid ColumnDefinitions="300,*,*,*,*,*,*"         BackgroundColor="Transparent"                                     
                                                  RowDefinitions="90" ColumnSpacing="15">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="PlaySong_Tapped" x:Name="PlaySong" NumberOfTapsRequired="2"/>

                                            <PointerGestureRecognizer PointerEntered="UserHoverOnSongInColView" 
                                                                PointerExited="UserHoverOutSongInColView"
                                                                  />

                                        </Grid.GestureRecognizers>
                                        <HorizontalStackLayout Grid.Column="0" Margin="5,0,0,0" 
                                                           HorizontalOptions="Start" 
                                            VerticalOptions="Center">
                                            <VerticalStackLayout>

                                                <Image WidthRequest="30" HeightRequest="30" 
                                                   HorizontalOptions="Start"  
    IsVisible="{Binding HasLyrics}" Source="lyrics.png" Opacity="1"
           BackgroundColor="Transparent">

                                                </Image>

                                                <Image Source="songc.png" IsVisible="{Binding IsCurrentPlayingHighlight}"
           WidthRequest="25" Opacity="1"
           HorizontalOptions="Start">

                                                </Image>
                                            </VerticalStackLayout>
                                            <Label Text="{Binding Title}" Grid.Column="1" 
                                                FontSize="22" HorizontalOptions="Start"
                                                LineBreakMode="TailTruncation"/>


                                        </HorizontalStackLayout>

                                        <Label Grid.Column="1" FontSize="16" HorizontalOptions="Start"
                                        Text="{Binding ArtistName}" LineBreakMode="TailTruncation"/>

                                        <Label Grid.Column="2" Text="{Binding AlbumName}" LineBreakMode="TailTruncation" 
                                                   FontSize="16" />

                                        <Label Grid.Column="3" HorizontalOptions="Center" LineBreakMode="TailTruncation"
                                    Text="{Binding Genre}" 
                                                   FontSize="16" />

                                        <Label Grid.Column="4" 
                                HorizontalOptions="Center" FontSize="16"/>
                                        <Label Grid.Column="5" HorizontalOptions="Center" Text="{Binding FileFormat}" FontSize="16" Opacity="0.8"/>
                                        <Label Grid.Column="6" HorizontalOptions="Center" Text="{Binding ReleaseYear}" FontSize="16" Opacity="0.8"/>


                                    </Grid>

                                </syncf:SfEffectsView>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>


        </Grid>
    </Grid>

</ContentPage>