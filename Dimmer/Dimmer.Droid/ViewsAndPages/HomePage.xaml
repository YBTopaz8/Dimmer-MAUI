<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Dimmer.ViewsAndPages.HomePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:Dimmer.Utilities.TypeConverters;assembly=Dimmer"
    xmlns:dx="http://schemas.devexpress.com/maui"
    xmlns:models="clr-namespace:Dimmer.Data.ModelView;assembly=Dimmer"
    xmlns:vm="clr-namespace:Dimmer.ViewModels"
    Title="HomePage"
    x:DataType="vm:BaseViewModelAnd"
    x:FieldModifier="Public"
    BackgroundColor="{AppThemeBinding Light=#F5F5F5,
                                      Dark=#1131314}"
    Shell.FlyoutBehavior="Flyout"
    Shell.NavBarIsVisible="False"
    Shell.TabBarIsVisible="False">

    <ContentPage.Resources>
        <ResourceDictionary>


            <DataTemplate x:Key="OGView" x:DataType="models:SongModelView">

                <dx:DXStackLayout x:Name="ParentSL">

                    <Grid
                        x:Name="ParentGrid"
                        BackgroundColor="Transparent"
                        ColumnDefinitions="60,*,auto"
                        ColumnSpacing="1"
                        RowDefinitions="60"
                        VerticalOptions="Center">

                        <dx:DXButton
                            x:Name="TitleAndArtists"
                            Grid.Column="1"
                            Padding="0"
                            HorizontalContentAlignment="Start"
                            BackgroundColor="Transparent"
                            Clicked="PlaySongClicked"
                            CommandParameter="{Binding .}"
                            CornerRadius="5"
                            PressedTextColor="White"
                            VerticalOptions="Center">
                            <dx:DXButton.Content>
                                <dx:DXStackLayout x:Name="ParentDSL">
                                    <Label
                                        x:Name="SongTitleChip"
                                        Padding="10,0"
                                        BackgroundColor="Transparent"
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        HorizontalOptions="Start"
                                        LineBreakMode="TailTruncation"
                                        Opacity="0.8"
                                        Text="{Binding Title}"
                                        TextColor="{AppThemeBinding Dark=White,
                                                                    Light=black}"
                                        VerticalOptions="Center">
                                        <Label.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsCurrentPlayingHighlight}"
                                                TargetType="Label"
                                                Value="True">
                                                <Setter Property="TextColor" Value="DarkSlateBlue" />
                                                <Setter Property="FontSize" Value="18" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>


                                    <dx:Chip
                                        x:Name="ArtistsChip"
                                        Padding="10,0"
                                        BackgroundColor="Transparent"
                                        BorderThickness="0"
                                        DoubleTapCommandParameter="{Binding .}"
                                        FontSize="12"
                                        HorizontalOptions="Start"
                                        LongPressCommandParameter="{Binding OtherArtistsName}"
                                        Opacity="0.6"
                                        Tap="ArtistsChip_Tap"
                                        Text="{Binding ArtistName}"
                                        TextColor="{AppThemeBinding Dark=White,
                                                                    Light=black}"
                                        VerticalOptions="Center" />

                                    <dx:Chip
                                        x:Name="AlbumFilter"
                                        Padding="10,0"
                                        BackgroundColor="Transparent"
                                        BorderThickness="0"
                                        FontAttributes="Italic"
                                        FontSize="10"
                                        HorizontalOptions="Start"
                                        LongPress="AlbumFilter_LongPress"
                                        LongPressCommandParameter="{Binding AlbumName}"
                                        Opacity="0.5"
                                        Text="{Binding AlbumName}"
                                        UseRippleEffect="True"
                                        VerticalOptions="Center" />



                                </dx:DXStackLayout>

                            </dx:DXButton.Content>
                        </dx:DXButton>






                        <dx:Chip
                            x:Name="MoreIcon"
                            Grid.Column="2"
                            Padding="20"
                            BorderColor="DarkSlateBlue"
                            BorderThickness="0.7"
                            CornerRadius="25"
                            FontSize="15"
                            HorizontalOptions="End"
                            IsIconVisible="False"
                            LongPress="MoreIcon_LongPress"
                            PressedBackgroundColor="DarkSlateBlue"
                            PressedBorderColor="DarkSlateBlue"
                            Tap="MoreIcon_Tap"
                            TapCommandParameter="{Binding .}"
                            Text="{Binding DurationInSeconds, Converter={converters:DurationConverterFromMsToTimeSpan}}"
                            TextColor="{AppThemeBinding Dark=White,
                                                        Light=black}" />



                        <dx:DXPopup
                            x:Name="ArtistsContextMenu"
                            x:FieldModifier="Public"
                            AllowScrim="True"
                            AllowShadow="True"
                            Opened="ArtistsContextMenu_Opened"
                            Placement="Right"
                            PlacementTarget="{x:Reference ViewSongOnly}"
                            ScrimColor="DarkSlateBlue"
                            ShadowColor="DarkSlateBlue"
                            ShadowRadius="10">
                            <dx:DXPopup.Content>


                                <dx:DXStackLayout
                                    Padding="10"
                                    ItemSpacing="5"
                                    MaximumHeightRequest="450"
                                    Orientation="Vertical"
                                    VerticalOptions="Start">
                                    <Label
                                        HorizontalTextAlignment="Center"
                                        Text="Songs by :"
                                        TextColor="{AppThemeBinding Light=DimGray,
                                                                    Dark=White}" />

                                    <BoxView HeightRequest="2" Color="DarkGray" />
                                    <dx:DXCollectionView
                                        x:Name="ArtistNamesColView"
                                        x:FieldModifier="Public"
                                        HeightRequest="250"
                                        ItemSpacing="10"
                                        Loaded="ArtistNamesColView_Loaded">
                                        <dx:DXCollectionView.ItemTemplate>

                                            <DataTemplate x:DataType="models:ArtistModelView">
                                                <Grid
                                                    BackgroundColor="Transparent"
                                                    ColumnDefinitions="*,auto"
                                                    RowDefinitions="auto,*">
                                                    <dx:Chip
                                                        x:Name="ArtistChipName"
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        Padding="10"
                                                        CornerRadius="20"
                                                        FontAutoScalingEnabled="True"
                                                        HorizontalOptions="Center"
                                                        PressedBackgroundColor="DarkSlateBlue"
                                                        PressedTextColor="White"
                                                        Tap="ArtistChipName_Tap"
                                                        Text="{Binding Name}"
                                                        TextColor="{AppThemeBinding Light=Black,
                                                                                    Dark=White}" />


                                                    <dx:DXExpander
                                                        x:Name="DimmerIconChip"
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        IsExpanded="True">
                                                        <dx:DXExpander.Content>
                                                            <dx:DXImage
                                                                HeightRequest="35"
                                                                Source="searchalta.png"
                                                                WidthRequest="35" />
                                                        </dx:DXExpander.Content>
                                                    </dx:DXExpander>

                                                    <dx:DXExpander x:Name="DimmerIconChipTwo" IsExpanded="False">
                                                        <dx:DXExpander.Content>
                                                            <dx:DXStackLayout Orientation="Horizontal">
                                                                <dx:Chip
                                                                    Grid.Row="0"
                                                                    Grid.Column="1"
                                                                    HeightRequest="35"
                                                                    Tap="AddArtistToTQL_Tap"
                                                                    TapCommandParameter="{Binding .}"
                                                                    Text="+"
                                                                    ToolTipProperties.Text="{Binding Name, StringFormat='Add songs by {0}'}"
                                                                    WidthRequest="35" />
                                                                <dx:Chip
                                                                    HeightRequest="35"
                                                                    Text="="
                                                                    ToolTipProperties.Text="Show Only Songs"
                                                                    WidthRequest="35" />
                                                            </dx:DXStackLayout>
                                                        </dx:DXExpander.Content>
                                                    </dx:DXExpander>




                                                </Grid>
                                            </DataTemplate>
                                        </dx:DXCollectionView.ItemTemplate>

                                    </dx:DXCollectionView>


                                    <dx:DXStackLayout
                                        BackgroundColor="Transparent"
                                        HorizontalOptions="End"
                                        ItemSpacing="10"
                                        Orientation="Horizontal">
                                        <dx:Chip
                                            x:Name="RandomSearch"
                                            BorderColor="Transparent"
                                            FontAttributes="Italic"
                                            FontSize="12"
                                            HorizontalOptions="End"
                                            Tap="RandomSearch_Tap"
                                            Text="Random Search"
                                            TextColor="DarkOliveGreen" />
                                        <dx:Chip
                                            x:Name="ClearSearch"
                                            BorderColor="DarkRed"
                                            FontAttributes="Bold"
                                            FontSize="12"
                                            HorizontalOptions="End"
                                            Tap="ClearSearch_Tap"
                                            Text="Clear Search"
                                            TextColor="DarkRed" />
                                    </dx:DXStackLayout>
                                </dx:DXStackLayout>

                            </dx:DXPopup.Content>

                        </dx:DXPopup>
                    </Grid>


                </dx:DXStackLayout>
            </DataTemplate>
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid x:Name="RootLayout" Margin="0">
        <!--<dx:DXImage
            Aspect="AspectFill"
            Opacity="{AppThemeBinding Light=0,
                                      Dark=0.09}"
            Source="{Binding CurrentPlayingSongView.CoverImageBytes, Converter={converters:BytesArrayToImageSource}}" />-->

        <dx:SafeKeyboardAreaView
            x:Name="myPageSKAV"
            Closed="myPageSKAV_Closed"
            FitKeyboardAreaToContent="SizeToContent"
            IsVisible="True">
            <dx:DXDockLayout x:Name="HomeView" BackgroundColor="Transparent">


                <!--<dx:DXScrollView x:Name="MainPageScrollView">-->

                <Grid
                    x:Name="SearchContentView"
                    Margin="0,0"
                    x:DataType="vm:BaseViewModelAnd"
                    IsVisible="True"
                    RowDefinitions="auto,*,auto"
                    RowSpacing="0">

                    <Grid Grid.Row="0">
                        <dx:DXExpander
                            x:Name="TopBeforeColView"
                            x:FieldModifier="Public"
                            IsExpanded="{Binding IsNowAllSongsQueue}">
                            <dx:DXStackLayout>
                                <dx:DXStackLayout.Resources>
                                    <ResourceDictionary>
                                        <converters:DurationConverterFromMsToTimeSpan x:Key="DurationConverter" />
                                        <converters:BytesToMegabytesConverter x:Key="FileSizeConverter" />
                                        <converters:BytesArrayToImageSource x:Key="BytesToImageConverter" />
                                        <converters:BoolToInverseConverter x:Key="BoolToInverse" />
                                        <Style TargetType="dx:DXButton">
                                            <Setter Property="ButtonType" Value="ToolButton" />
                                            <Setter Property="HorizontalContentAlignment" Value="Start" />
                                            <Setter Property="IconHeight" Value="30" />
                                            <Setter Property="IconWidth" Value="30" />
                                            <Setter Property="IconColor" Value="#585858" />
                                        </Style>
                                    </ResourceDictionary>
                                </dx:DXStackLayout.Resources>

                                <dx:DXStackLayout
                                    BackgroundColor="Transparent"
                                    CornerRadius="20"
                                    HorizontalOptions="Center"
                                    IsVisible="False"
                                    Orientation="Horizontal">

                                    <dx:DXButton
                                        HorizontalOptions="Start"
                                        Icon="searchd.png"
                                        ShowIcon="True" />

                                    <dx:DXButton
                                        HorizontalOptions="Start"
                                        Icon="shuffle.png"
                                        ShowIcon="True" />

                                    <dx:DXButton
                                        HorizontalOptions="Start"
                                        Icon="playlistadd.png"
                                        ShowIcon="True" />

                                </dx:DXStackLayout>

                                <dx:TextEdit
                                    x:Name="SearchBy"
                                    Margin="10"
                                    x:FieldModifier="Public"
                                    BorderColor="#585858"
                                    CornerRadius="20"
                                    Focused="SearchBy_Focused"
                                    FocusedBorderColor="DarkSlateBlue"
                                    Loaded="SearchBy_Loaded"
                                    PlaceholderColor="DarkSlateBlue"
                                    PlaceholderText="Search..."
                                    StartIcon="searchd.png"
                                    StartIconColor="DarkSlateBlue"
                                    TextChanged="SearchBy_TextChanged"
                                    Unloaded="SearchBy_Unloaded" />
                                <dx:DXStackLayout
                                    x:Name="OpenedKeyboardToolbar"
                                    BackgroundColor="Transparent"
                                    IsVisible="True">

                                    <HorizontalStackLayout
                                        Grid.Column="1"
                                        BackgroundColor="Transparent"
                                        HorizontalOptions="End"
                                        Spacing="5"
                                        VerticalOptions="Start">
                                        <Label
                                            x:Name="SongsCountLabel"
                                            Text="{Binding SearchResults.Count, StringFormat='Songs : {0}'}"
                                            TextColor="{AppThemeBinding Dark=#999999,
                                                                        Light=black}" />

                                    </HorizontalStackLayout>


                                </dx:DXStackLayout>
                                <Label
                                    x:Name="MyProgressLabel"
                                    HeightRequest="70"
                                    IsVisible="False" />
                                <ProgressBar
                                    x:Name="MyProgressBar"
                                    IsVisible="False"
                                    WidthRequest="80" />


                            </dx:DXStackLayout>
                        </dx:DXExpander>
                    </Grid>

                    <Grid Grid.Row="1">
                        <dx:TabView
                            x:Name="MainViewTabView"
                            HeaderPanelBackgroundColor="Transparent"
                            HeaderPanelHeight="0"
                            HeaderPanelMinWidth="1"
                            HeaderPanelPadding="-50"
                            HeaderPanelPosition="Top"
                            ItemHeaderFontFamily="MatRoundReg"
                            ScrollAnimationEnabled="True"
                            SelectedItemIndex="{Binding NowPlayingTabIndex, Mode=TwoWay}"
                            SelectedItemIndicatorColor="{Binding CurrentPlaySongDominantColor}">


                            <dx:TabViewItem>
                                <Grid>

                                    <HorizontalStackLayout
                                        Margin="5,0"
                                        HorizontalOptions="End"
                                        Spacing="10"
                                        VerticalOptions="End"
                                        ZIndex="1">
                                        <dx:Chip
                                            x:Name="Settings"
                                            BackgroundColor="DarkSlateBlue"
                                            BorderThickness="0"
                                            Icon="settings.png"
                                            IconColor="White"
                                            IconSize="35,35"
                                            IsIconVisible="True"
                                            Tap="Settings_Tap"
                                            WidthRequest="43" />

                                        <dx:Chip
                                            x:Name="ScrollToCurrSong"
                                            BackgroundColor="DarkSlateBlue"
                                            BorderThickness="0"
                                            Icon="eye.png"
                                            IconColor="White"
                                            IconSize="35,35"
                                            IsIconVisible="True"
                                            Tap="ScrollToCurrSong_Tap"
                                            WidthRequest="43" />







                                    </HorizontalStackLayout>
                                    <dx:DXStackLayout ZIndex="0">
                                        <dx:DXStackLayout.Resources>
                                            <ResourceDictionary />
                                        </dx:DXStackLayout.Resources>
                                        <dx:DXCollectionView
                                            x:Name="SongsColView"
                                            Grid.Row="0"
                                            x:FieldModifier="Public"
                                            AllowDragDropItems="False"
                                            AllowFixedGroupHeaders="True"
                                            AllowGroupCollapse="True"
                                            AllowLiveDataShaping="True"
                                            BackgroundColor="Transparent"
                                            FilteringUIFormShowing="SongsColView_FilteringUIFormShowing"
                                            ItemSpacing="10"
                                            ItemTemplate="{StaticResource OGView}"
                                            ItemsSource="{Binding SearchResults}"
                                            Loaded="SongsColView_Loaded"
                                            LongPressCommand="{Binding Commands.ShowFilteringUIForm, Source={x:Reference SongsColView}}"
                                            UseRippleEffect="False" />
                                    </dx:DXStackLayout>

                                </Grid>
                            </dx:TabViewItem>


                            <dx:TabViewItem>

                                <Grid
                                    Margin="5"
                                    IsVisible="True"
                                    RowDefinitions="*,auto,auto">
                                    <Grid Grid.Row="0">

                                        <dx:DXBorder CornerRadius="15" StyleClass="Elevation2">
                                            <dx:DXBorder.Triggers>

                                                <DataTrigger
                                                    Binding="{Binding CurrentPlayingSongView.HasSyncedLyrics}"
                                                    TargetType="dx:DXBorder"
                                                    Value="true">
                                                    <Setter Property="BorderColor" Value="{Binding CurrentPlaySongDominantColor}" />
                                                </DataTrigger>
                                            </dx:DXBorder.Triggers>
                                            <Grid>

                                                <dx:DXImage
                                                    Grid.Row="0"
                                                    Aspect="AspectFit"
                                                    IsVisible="True"
                                                    Source="{Binding CurrentCoverImagePath}">
                                                    <dx:DXImage.Triggers>
                                                        <DataTrigger
                                                            Binding="{Binding AllLines, Converter={converters:IsEnumerableNullOrEmptyConverter}}"
                                                            TargetType="dx:DXImage"
                                                            Value="True">
                                                            <Setter Property="Opacity" Value="0.9" />
                                                        </DataTrigger>
                                                        <DataTrigger
                                                            Binding="{Binding AllLines, Converter={converters:IsEnumerableNullOrEmptyConverter}}"
                                                            TargetType="dx:DXImage"
                                                            Value="False">
                                                            <Setter Property="Opacity" Value="0.5" />
                                                        </DataTrigger>
                                                    </dx:DXImage.Triggers>
                                                </dx:DXImage>
                                                <VerticalStackLayout
                                                    x:Name="LyricsSection"
                                                    HorizontalOptions="Center"
                                                    IsVisible="True"
                                                    VerticalOptions="Center">
                                                    <VerticalStackLayout.Triggers>

                                                        <DataTrigger
                                                            Binding="{Binding CurrentPlayingSongView.HasSyncedLyrics}"
                                                            TargetType="VerticalStackLayout"
                                                            Value="true">
                                                            <Setter Property="IsVisible" Value="True" />
                                                        </DataTrigger>

                                                        <DataTrigger
                                                            Binding="{Binding IsPlaying}"
                                                            TargetType="VerticalStackLayout"
                                                            Value="false">
                                                            <Setter Property="IsVisible" Value="False" />
                                                        </DataTrigger>

                                                        <DataTrigger
                                                            Binding="{Binding AllLines.Count, Converter={converters:CollectionSizeToVisibility}}"
                                                            TargetType="VerticalStackLayout"
                                                            Value="false">
                                                            <Setter Property="IsVisible" Value="False" />
                                                        </DataTrigger>
                                                    </VerticalStackLayout.Triggers>

                                                    <Label
                                                        FontSize="15"
                                                        HorizontalTextAlignment="Center"
                                                        Opacity="0.7"
                                                        Text="{Binding PreviousLine.Text}" />
                                                    <Grid HorizontalOptions="Center">
                                                        <Border BackgroundColor="{AppThemeBinding Dark=#1e1e1e}" Opacity="0.7" />
                                                        <Label
                                                            Margin="10"
                                                            FontAttributes="Bold"
                                                            FontSize="36"
                                                            HorizontalTextAlignment="Center"
                                                            Opacity="1"
                                                            Text="{Binding CurrentLine.Text}"
                                                            TextColor="DarkSlateBlue">
                                                            <Label.Triggers />
                                                        </Label>
                                                    </Grid>
                                                    <Label
                                                        FontSize="17"
                                                        HorizontalTextAlignment="Center"
                                                        Opacity="0.7"
                                                        Text="{Binding NextLine.Text}" />
                                                </VerticalStackLayout>

                                            </Grid>
                                        </dx:DXBorder>

                                        <!--<dx:DXCollectionView
                                            x:Name="AllLyricsColView"
                                            Margin="10"
                                            HeightRequest="150"
                                            HorizontalOptions="Center"
                                            IsScrollBarVisible="False"
                                            IsVisible="{Binding IsPlaying}"
                                            ItemsSource="{Binding AllLines}"
                                            SelectedItem="{Binding CurrentLine}"
                                            SelectionChanged="DXCollectionView_SelectionChanged"
                                            SelectionMode="Single"
                                            VerticalOptions="Center"
                                            ZIndex="1">
                                            <dx:DXCollectionView.SelectedItemTemplate>
                                                <DataTemplate x:DataType="models:LyricPhraseModelView">
                                                    <dx:DXBorder
                                                        Margin="5"
                                                        Padding="10"
                                                        BackgroundColor="DarkSlateBlue"
                                                        CornerRadius="10"
                                                        HorizontalOptions="Center">
                                                        <Label
                                                            FontAttributes="Bold"
                                                            HorizontalTextAlignment="Center"
                                                            Text="{Binding Text}"
                                                            TextColor="{AppThemeBinding Dark=White,
                                                                                        Light=White}" />

                                                    </dx:DXBorder>
                                                </DataTemplate>
                                            </dx:DXCollectionView.SelectedItemTemplate>
                                            <dx:DXCollectionView.ItemTemplate>
                                                <DataTemplate x:DataType="models:LyricPhraseModelView">
                                                    <Border>
                                                        <Label
                                                            FontSize="13"
                                                            HorizontalTextAlignment="Center"
                                                            Text="{Binding Text}"
                                                            TextColor="Black" />

                                                    </Border>
                                                </DataTemplate>
                                            </dx:DXCollectionView.ItemTemplate>
                                        </dx:DXCollectionView>-->
                                        <dx:DXBorder
                                            BackgroundColor="{Binding CurrentPlaySongDominantColor}"
                                            CornerRadius="0,0,10,15"
                                            Opacity="0.8"
                                            VerticalOptions="End">

                                            <Grid BackgroundColor="DarkSlateBlue" ColumnDefinitions="*,*">
                                                <dx:DXStackLayout Grid.Column="0" HorizontalOptions="Start">
                                                    <dx:Chip
                                                        BackgroundColor="Transparent"
                                                        BorderColor="Transparent"
                                                        BorderThickness="0.1"
                                                        FontSize="14"
                                                        Tap="ArtistChip_Tap"
                                                        TapCommandParameter="{Binding CurrentPlayingSongView}"
                                                        Text="{Binding CurrentPlayingSongView.ReleaseYear}"
                                                        TextColor="{AppThemeBinding Light=White,
                                                                                    Dark=white}" />
                                                </dx:DXStackLayout>
                                                <dx:DXStackLayout Grid.Column="1" HorizontalOptions="End">
                                                    <dx:Chip
                                                        BackgroundColor="Transparent"
                                                        BorderColor="Transparent"
                                                        BorderThickness="0.1"
                                                        FontSize="14"
                                                        Tap="ArtistChip_Tap"
                                                        TapCommandParameter="{Binding CurrentPlayingSongView}"
                                                        Text="{Binding CurrentPlayingSongView.GenreName}"
                                                        TextColor="{AppThemeBinding Light=white,
                                                                                    Dark=white}" />
                                                </dx:DXStackLayout>
                                            </Grid>

                                        </dx:DXBorder>
                                    </Grid>

                                    <dx:DXExpander
                                        x:Name="MediaControlView"
                                        Grid.Row="1"
                                        IsExpanded="True">
                                        <Grid>

                                            <dx:DXStackLayout Grid.Row="1" IsVisible="True">
                                                <dx:DXStackLayout
                                                    Margin="0,0,0,0"
                                                    BackgroundColor="Transparent"
                                                    ItemSpacing="5">
                                                    <dx:DXStackLayout.Resources>
                                                        <ResourceDictionary>
                                                            <Style TargetType="dx:Chip">
                                                                <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
                                                            </Style>
                                                            <Style TargetType="Label">
                                                                <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=#999999}" />
                                                            </Style>
                                                        </ResourceDictionary>
                                                    </dx:DXStackLayout.Resources>

                                                    <dx:Chip
                                                        x:Name="TitleChip"
                                                        FontAttributes="Bold"
                                                        FontSize="22"
                                                        HorizontalOptions="Start"
                                                        Tap="TitleChip_Tap"
                                                        Text="{Binding CurrentPlayingSongView.Title}">
                                                        <dx:Chip.Triggers>
                                                            <DataTrigger
                                                                Binding="{Binding IsDimmerPlaying}"
                                                                TargetType="dx:Chip"
                                                                Value="True">
                                                                <Setter Property="TextColor" Value="DarkSlateBlue" />
                                                                <Setter Property="BorderThickness" Value="1" />
                                                            </DataTrigger>
                                                            <DataTrigger
                                                                Binding="{Binding IsDimmerPlaying}"
                                                                TargetType="dx:Chip"
                                                                Value="False">
                                                                <Setter Property="TextColor" Value="Grey" />
                                                                <Setter Property="BorderThickness" Value="0" />
                                                            </DataTrigger>
                                                        </dx:Chip.Triggers>
                                                    </dx:Chip>

                                                    <dx:Chip
                                                        x:Name="ArtistNameChip"
                                                        BackgroundColor="Transparent"
                                                        FontAttributes="Bold"
                                                        FontSize="16"
                                                        Loaded="ArtistNameChip_Loaded"
                                                        TapCommandParameter="{Binding CurrentPlayingSongView.OtherArtistsName}"
                                                        Text="{Binding CurrentPlayingSongView.ArtistName}"
                                                        Unloaded="ArtistNameChip_Unloaded">
                                                        <dx:Chip.Triggers>
                                                            <DataTrigger
                                                                Binding="{Binding IsDimmerPlaying}"
                                                                TargetType="dx:Chip"
                                                                Value="True">
                                                                <Setter Property="BorderThickness" Value="1" />
                                                            </DataTrigger>
                                                            <DataTrigger
                                                                Binding="{Binding IsDimmerPlaying}"
                                                                TargetType="dx:Chip"
                                                                Value="False">
                                                                <Setter Property="BorderThickness" Value="0" />
                                                            </DataTrigger>
                                                        </dx:Chip.Triggers>
                                                    </dx:Chip>
                                                    <dx:Chip
                                                        BackgroundColor="Transparent"
                                                        FontSize="13"
                                                        Text="{Binding CurrentPlayingSongView.AlbumName}"
                                                        TextColor="{AppThemeBinding Light=Black,
                                                                                    Dark=White}">
                                                        <dx:Chip.Triggers>
                                                            <DataTrigger
                                                                Binding="{Binding IsDimmerPlaying}"
                                                                TargetType="dx:Chip"
                                                                Value="True">
                                                                <Setter Property="BorderThickness" Value="1" />
                                                            </DataTrigger>
                                                            <DataTrigger
                                                                Binding="{Binding IsDimmerPlaying}"
                                                                TargetType="dx:Chip"
                                                                Value="False">
                                                                <Setter Property="BorderThickness" Value="0" />
                                                            </DataTrigger>
                                                        </dx:Chip.Triggers>
                                                    </dx:Chip>


                                                    <dx:DXStackLayout HorizontalOptions="Center" Orientation="Horizontal">

                                                        <dx:Chip
                                                            BackgroundColor="Transparent"
                                                            BorderColor="Transparent"
                                                            BorderThickness="0.1"
                                                            FontSize="18"
                                                            Icon="heartbroken.png"
                                                            IsIconVisible="True"
                                                            LongPressCommand="{Binding AddFavoriteRatingToSongCommand}"
                                                            Tap="ArtistChip_Tap">
                                                            <dx:Chip.Triggers>
                                                                <DataTrigger
                                                                    Binding="{Binding CurrentPlayingSongView.IsFavorite}"
                                                                    TargetType="dx:Chip"
                                                                    Value="True">
                                                                    <Setter Property="Icon" Value="heart.png" />
                                                                </DataTrigger>
                                                                <DataTrigger
                                                                    Binding="{Binding CurrentPlayingSongView.IsFavorite}"
                                                                    TargetType="dx:Chip"
                                                                    Value="False">
                                                                    <Setter Property="Icon" Value="heartbroken.png" />
                                                                </DataTrigger>
                                                            </dx:Chip.Triggers>
                                                        </dx:Chip>

                                                    </dx:DXStackLayout>
                                                </dx:DXStackLayout>
                                                <Grid
                                                    Grid.Row="2"
                                                    RowDefinitions="auto,auto,auto"
                                                    RowSpacing="15">

                                                    <Grid
                                                        x:Name="ProgressAndPrev"
                                                        Grid.Row="0"
                                                        BackgroundColor="Transparent"
                                                        ColumnDefinitions="0.4*,0.4*,*"
                                                        ColumnSpacing="10">

                                                        <dx:DXButton
                                                            Grid.Column="0"
                                                            BackgroundColor="#343534"
                                                            Command="{Binding ToggleRepeatModeCommand}"
                                                            HeightRequest="100"
                                                            Icon="repeat.png"
                                                            IconColor="{AppThemeBinding Dark=#f5f5f5,
                                                                                        Light=White}"
                                                            IconHeight="40"
                                                            IconWidth="40"
                                                            Opacity="0.5"
                                                            PressedBackgroundColor="{Binding CurrentPlaySongDominantColor}"
                                                            ToolTipProperties.Text="{Binding CurrentRepeatMode, StringFormat='{0}'}">
                                                            <dx:DXButton.Triggers>
                                                                <DataTrigger
                                                                    Binding="{Binding CurrentRepeatMode}"
                                                                    TargetType="dx:DXButton"
                                                                    Value="0">
                                                                    <Setter Property="BackgroundColor" Value="DarkSlateBlue" />

                                                                </DataTrigger>
                                                                <DataTrigger
                                                                    Binding="{Binding CurrentRepeatMode}"
                                                                    TargetType="dx:DXButton"
                                                                    Value="1">
                                                                    <Setter Property="BackgroundColor" Value="DarkSlateBlue" />

                                                                </DataTrigger>
                                                                <DataTrigger
                                                                    Binding="{Binding CurrentRepeatMode}"
                                                                    TargetType="dx:DXButton"
                                                                    Value="2">
                                                                    <Setter Property="BackgroundColor" Value="Orange" />

                                                                </DataTrigger>
                                                                <DataTrigger
                                                                    Binding="{Binding CurrentRepeatMode}"
                                                                    TargetType="dx:DXButton"
                                                                    Value="3">
                                                                    <Setter Property="BackgroundColor" Value="DarkBlue" />

                                                                </DataTrigger>
                                                            </dx:DXButton.Triggers>
                                                        </dx:DXButton>

                                                        <dx:DXButton
                                                            Grid.Column="1"
                                                            BackgroundColor="#343534"
                                                            Command="{Binding PreviousTrackCommand}"
                                                            HeightRequest="100"
                                                            Icon="skipprevious.png"
                                                            IconColor="{AppThemeBinding Dark=#f5f5f5,
                                                                                        Light=White}"
                                                            IconHeight="50"
                                                            IconWidth="50"
                                                            Opacity="0.5"
                                                            PressedBackgroundColor="{Binding CurrentPlaySongDominantColor}" />
                                                        <Grid
                                                            Grid.Column="2"
                                                            BackgroundColor="Transparent"
                                                            ColumnDefinitions="*,*"
                                                            RowDefinitions="*,*">
                                                            <dx:DXSlider
                                                                x:Name="ProgressSlider"
                                                                Grid.Row="0"
                                                                Grid.Column="0"
                                                                Grid.ColumnSpan="2"
                                                                BackgroundColor="Transparent"
                                                                MaxValue="{Binding CurrentPlayingSongView.DurationInSeconds}"
                                                                MinValue="0"
                                                                Opacity="0.7"
                                                                TapReleased="ProgressSlider_TapReleased"
                                                                ValueStep="1"
                                                                VerticalOptions="End"
                                                                Value="{Binding CurrentTrackPositionSeconds}">


                                                                <dx:DXSlider.TooltipAppearance>
                                                                    <dx:DXSliderTooltipAppearance
                                                                        BackgroundColor="#626680"
                                                                        FontAttributes="Bold"
                                                                        FontSize="16"
                                                                        TextColor="{AppThemeBinding Dark=White,
                                                                                                    Light=black}" />
                                                                </dx:DXSlider.TooltipAppearance>

                                                                <dx:DXSlider.TrackAppearance>
                                                                    <dx:DXSliderTrackAppearance
                                                                        ActiveBackgroundColor="DarkSlateBlue"
                                                                        BackgroundColor="#626680"
                                                                        Thickness="12" />
                                                                </dx:DXSlider.TrackAppearance>
                                                                <dx:DXSlider.ThumbAppearance>
                                                                    <dx:DXSliderThumbAppearance
                                                                        Width="2"
                                                                        Height="35"
                                                                        BackgroundColor="DarkSlateBlue" />
                                                                </dx:DXSlider.ThumbAppearance>
                                                            </dx:DXSlider>
                                                            <Label
                                                                Grid.Row="1"
                                                                Grid.Column="0"
                                                                FontSize="14"
                                                                Text="{Binding CurrentTrackPositionSeconds, Converter={StaticResource DurationConverter}}" />
                                                            <Label
                                                                Grid.Row="1"
                                                                Grid.Column="1"
                                                                FontSize="14"
                                                                HorizontalOptions="End"
                                                                Text="{Binding CurrentPlayingSongView.DurationInSeconds, Converter={StaticResource DurationConverter}}" />
                                                        </Grid>

                                                    </Grid>

                                                    <Grid
                                                        x:Name="PlayPauseAndNext"
                                                        Grid.Row="1"
                                                        BackgroundColor="Transparent"
                                                        ColumnDefinitions="*,0.4*,0.4*"
                                                        ColumnSpacing="10">
                                                        <dx:DXButton
                                                            Grid.Column="0"
                                                            Command="{Binding PlayPauseToggleCommand}"
                                                            HeightRequest="100"
                                                            Icon="play.png"
                                                            IconHeight="60"
                                                            IconWidth="60"
                                                            Opacity="0.8">
                                                            <dx:DXButton.Triggers>

                                                                <DataTrigger
                                                                    Binding="{Binding IsDimmerPlaying}"
                                                                    TargetType="dx:DXButton"
                                                                    Value="True">
                                                                    <Setter Property="Icon" Value="pause.png" />
                                                                </DataTrigger>
                                                                <DataTrigger
                                                                    Binding="{Binding IsDimmerPlaying}"
                                                                    TargetType="dx:DXButton"
                                                                    Value="False">
                                                                    <Setter Property="Icon" Value="play.png" />
                                                                </DataTrigger>
                                                            </dx:DXButton.Triggers>
                                                        </dx:DXButton>

                                                        <dx:DXToggleButton
                                                            Grid.Column="1"
                                                            AnimationDuration="800"
                                                            BackgroundColor="{AppThemeBinding Dark=#343534,
                                                                                              Light=grey}"
                                                            Command="{Binding ToggleShuffleCommand}"
                                                            HeightRequest="100"
                                                            Icon="shuffle.png"
                                                            IconColor="{AppThemeBinding Dark=#f5f5f5,
                                                                                        Light=White}"
                                                            IconHeight="40"
                                                            IconWidth="40"
                                                            IsChecked="{Binding IsShuffleActive}"
                                                            Opacity="0.5"
                                                            PressedBackgroundColor="{Binding CurrentPlaySongDominantColor}" />

                                                        <dx:DXButton
                                                            Grid.Column="2"
                                                            AnimationDuration="800"
                                                            BackgroundColor="{AppThemeBinding Dark=#343534,
                                                                                              Light=grey}"
                                                            Command="{Binding NextTrackCommand}"
                                                            HeightRequest="100"
                                                            Icon="skipnext.png"
                                                            IconColor="{AppThemeBinding Dark=#f5f5f5,
                                                                                        Light=White}"
                                                            IconHeight="40"
                                                            IconWidth="40"
                                                            Opacity="0.5"
                                                            PressedBackgroundColor="{Binding CurrentPlaySongDominantColor}" />

                                                    </Grid>

                                                </Grid>

                                            </dx:DXStackLayout>

                                        </Grid>
                                    </dx:DXExpander>

                                </Grid>
                            </dx:TabViewItem>
                        </dx:TabView>

                    </Grid>



                    <dx:DXExpander
                        x:Name="BtmBarExp"
                        Grid.Row="2"
                        BackgroundColor="Transparent"
                        IsExpanded="{Binding NowPlayingUI, Converter={converters:BoolToInverseConverter}}"
                        VerticalOptions="End">

                        <dx:DXBorder
                            x:Name="BtmBarr"
                            Loaded="BtmBarr_Loaded"
                            Unloaded="BtmBarr_Unloaded">


                            <dx:DXBorder.Resources>

                                <ResourceDictionary>
                                    <converters:DurationConverterFromMsToTimeSpan x:Key="DurationConverter" />
                                    <converters:BytesToMegabytesConverter x:Key="FileSizeConverter" />
                                    <converters:BytesArrayToImageSource x:Key="BytesToImageConverter" />
                                    <converters:BoolToInverseConverter x:Key="BoolToInverse" />
                                </ResourceDictionary>
                            </dx:DXBorder.Resources>


                            <dx:DXBorder.GestureRecognizers>
                                <TapGestureRecognizer x:Name="BtmBarTapGest" Tapped="BtmBarTapGest_Tapped" />

                            </dx:DXBorder.GestureRecognizers>
                            <dx:DXBorder.Content>
                                <dx:DXStackLayout
                                    x:Name="BtmBarStackLayout"
                                    Padding="0,0"
                                    x:FieldModifier="Public"
                                    BackgroundColor="{AppThemeBinding Light=#F5F5F5,
                                                                      Dark=#131314}">

                                    <ProgressBar
                                        BackgroundColor="Transparent"
                                        Progress="{Binding CurrentTrackPositionPercentage}"
                                        ProgressColor="DarkSlateBlue" />
                                    <Grid
                                        Padding="0,0"
                                        BackgroundColor="Transparent"
                                        ColumnDefinitions="auto,*"
                                        ColumnSpacing="5">
                                        <StackLayout Grid.Column="0" Orientation="Horizontal">
                                            <dx:DXImage
                                                Aspect="AspectFit"
                                                HeightRequest="70"
                                                Source="{Binding CurrentPlayingSongView.CoverImagePath}" />
                                        </StackLayout>
                                        <Grid Grid.Column="1" ColumnDefinitions="*,auto">

                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer x:Name="BtmBarTap" Tapped="BtmBarTap_Tapped" />
                                                <PanGestureRecognizer PanUpdated="PanGesture_PanUpdated" />
                                            </Grid.GestureRecognizers>
                                            <StackLayout
                                                Grid.Column="0"
                                                BackgroundColor="Transparent"
                                                HorizontalOptions="Start"
                                                Orientation="Vertical">
                                                <Label
                                                    FontSize="23"
                                                    HorizontalOptions="Start"
                                                    Text="{Binding CurrentPlayingSongView.Title}"
                                                    TextColor="DarkSlateBlue" />
                                                <Label
                                                    FontAttributes="Italic"
                                                    FontSize="14"
                                                    HorizontalOptions="Start"
                                                    Text="{Binding CurrentPlayingSongView.ArtistName}"
                                                    TextColor="{AppThemeBinding Light=Black,
                                                                                Dark=White}" />
                                            </StackLayout>

                                            <dx:Chip
                                                x:Name="DurationAndSearchChip"
                                                Grid.Column="1"
                                                BorderThickness="0"
                                                DoubleTap="DurationAndSearchChip_LongPress"
                                                LongPress="DurationAndSearchChip_LongPress"
                                                Tap="DurationAndSearchChip_LongPress">
                                                <dx:Chip.ContentTemplate>
                                                    <DataTemplate x:DataType="vm:BaseViewModelAnd">
                                                        <VerticalStackLayout>
                                                            <Label
                                                                FontSize="16"
                                                                HorizontalOptions="End"
                                                                Text="{Binding CurrentTrackPositionSeconds, Converter={x:StaticResource DurationConverter}}"
                                                                VerticalOptions="Center">
                                                                <Label.Triggers>
                                                                    <DataTrigger
                                                                        Binding="{Binding IsDimmerPlaying}" x:DataType="vm:BaseViewModelAnd"
                                                                        TargetType="Label"
                                                                        Value="True">
                                                                        <Setter Property="FontAttributes" Value="Bold" />
                                                                        <Setter Property="TextColor" Value="DarkSlateBlue" />
                                                                    </DataTrigger>
                                                                    <DataTrigger
                                                                        Binding="{Binding IsDimmerPlaying}"
                                                                        TargetType="Label" x:DataType="vm:BaseViewModelAnd"
                                                                        Value="False">
                                                                        <Setter Property="FontAttributes" Value="None" />
                                                                        <Setter Property="TextColor" Value="{AppThemeBinding Light=Black, Dark=White}" />
                                                                    </DataTrigger>
                                                                </Label.Triggers>
                                                            </Label>

                                                            <Label
                                                                FontSize="10"
                                                                HorizontalOptions="End"
                                                                Text="{Binding CurrentPlayingSongView.PlayCompletedCount}" />
                                                        </VerticalStackLayout>
                                                    </DataTemplate>
                                                </dx:Chip.ContentTemplate>

                                            </dx:Chip>
                                        </Grid>
                                    </Grid>
                                </dx:DXStackLayout>
                            </dx:DXBorder.Content>

                        </dx:DXBorder>



                    </dx:DXExpander>
                </Grid>
            </dx:DXDockLayout>
        </dx:SafeKeyboardAreaView>

        <dx:BottomSheet
            x:Name="MoreBtmSheet"
            HalfExpandedRatio="0.6"
            StateChanged="MoreBtmSheet_StateChanged">
            <dx:BottomSheet.Resources>
                <ResourceDictionary>

                    <Style TargetType="BoxView">

                        <Setter Property="Margin" Value="5,0" />
                        <Setter Property="HeightRequest" Value="0.5" />
                        <Setter Property="Color" Value="DarkSlateBlue" />

                    </Style>
                    <Style TargetType="dx:DXButton">
                        <Setter Property="BorderThickness" Value="0" />
                        <Setter Property="BackgroundColor" Value="Transparent" />
                        <Setter Property="Padding" Value="5" />
                        <Setter Property="TextColor" Value="{AppThemeBinding Light=black, Dark=White}" />
                        <Setter Property="HorizontalContentAlignment" Value="Start" />
                        <Setter Property="ShowIcon" Value="True" />
                        <Setter Property="IconColor" Value="DarkSlateBlue" />
                        <Setter Property="PressedIconColor" Value="White" />
                        <Setter Property="PressedBackgroundColor" Value="DarkSlateBlue" />
                        <Setter Property="IconHeight" Value="25" />
                        <Setter Property="IconWidth" Value="25" />
                    </Style>
                </ResourceDictionary>
            </dx:BottomSheet.Resources>
            <dx:BottomSheet.Content>
                <dx:DXStackLayout Margin="5" ItemSpacing="2">
                    <Grid ColumnDefinitions="120,*" ColumnSpacing="10">
                        <dx:DXImage
                            Grid.Column="0"
                            Margin="10,0,0,0"
                            Source="{Binding SelectedSong.CoverImagePath}" />
                        <dx:DXStackLayout Grid.Column="1" ItemSpacing="5">
                            <Label
                                FontSize="33"
                                HorizontalTextAlignment="Justify"
                                Text="{Binding SelectedSong.Title}"
                                ToolTipProperties.Text="Song Title" />
                            <Label
                                FontSize="16"
                                HorizontalOptions="Start"
                                Text="{Binding SelectedSong.ArtistName}"
                                ToolTipProperties.Text="Artist Name" />
                            <Label
                                FontSize="17"
                                LineBreakMode="WordWrap"
                                Text="{Binding SelectedSong.AlbumName}"
                                ToolTipProperties.Text="Album Name" />
                        </dx:DXStackLayout>
                    </Grid>


                    <dx:DXButton
                        x:Name="AddQuickNote"
                        Clicked="OnAddQuickNoteClicked"
                        CommandParameter="{Binding SelectedSong}"
                        Icon="chatdots.png">
                        <dx:DXButton.Content>
                            <MultiBinding StringFormat="{}Add Quick Note To: {0}">
                                <Binding Path="SelectedSong.Title" />
                            </MultiBinding>
                        </dx:DXButton.Content>

                    </dx:DXButton>
                    <BoxView
                        Margin="10,0"
                        HeightRequest="0.5"
                        Color="DarkSlateBlue" />

                    <dx:Chip
                        x:Name="ViewArtistMFI"
                        Icon="artist.png"
                        Tap="QuickSearchArtist_Clicked"
                        TapCommandParameter="{Binding SelectedSong.OtherArtistsName}"
                        Text="{Binding SelectedSong.OtherArtistsName, StringFormat='{0}'}" />
                    <dx:Chip
                        x:Name="ViewAlbumMFI"
                        Icon="musicalbum.png"
                        IconSize="30,40"
                        IsIconVisible="True"
                        Tap="QuickSearchAlbum_Clicked"
                        TapCommandParameter="{Binding SelectedSong.AlbumName}"
                        Text="{Binding SelectedSong.AlbumName, StringFormat='{0}'}" />
                    <dx:Chip
                        x:Name="ViewGenreMFI"
                        Icon="album.png"
                        IconSize="30,40"
                        IsIconVisible="True"
                        Tap="ViewGenreMFI_Clicked"
                        TapCommandParameter="{Binding SelectedSong.GenreName}"
                        Text="{Binding SelectedSong.GenreName, StringFormat='{0}'}" />

                    <BoxView
                        Margin="10,0"
                        HeightRequest="0.5"
                        Color="DarkSlateBlue" />

                    <dx:Chip
                        HeightRequest="50"
                        Icon="deletesonginterfacesymbol.png"
                        Tap="OnLabelClicked"
                        TapCommandParameter="DeleteSys"
                        Text="Delete from system" />

                    <dx:Chip
                        HeightRequest="50"
                        Icon="viewpage.png"
                        IsVisible="False"
                        Tap="OnLabelClicked"
                        TapCommandParameter="OpenFileExp"
                        Text="Open file from explorer" />
                    <dx:Chip
                        x:Name="SyncShare"
                        Icon="roundtransferhorizontal.png"
                        IsVisible="Hidden"
                        Tap="SyncShare_Tap"
                        TapCommandParameter="SyncShare"
                        Text="Sync" />

                </dx:DXStackLayout>
            </dx:BottomSheet.Content>
        </dx:BottomSheet>

    </Grid>
</ContentPage>