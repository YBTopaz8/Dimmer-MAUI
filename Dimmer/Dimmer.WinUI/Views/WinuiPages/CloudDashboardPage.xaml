<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="Dimmer.WinUI.Views.WinuiPages.CloudDashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:Dimmer.WinUI.Views.WinuiPages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:Dimmer.Data.ModelView;assembly=Dimmer"
    xmlns:modelsLive="using:Dimmer.DimmerLive.Models"
    Background="Transparent"
    mc:Ignorable="d">

    <Page.Resources>
        <!--  Acrylic & Card Styles  -->
        <SolidColorBrush x:Key="CardBackgroundBrush" Color="#15FFFFFF" />
        <SolidColorBrush x:Key="CardBorderBrush" Color="#20FFFFFF" />

        <Style x:Key="GlassCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource CardBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource CardBorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Margin" Value="0,0,0,16" />
        </Style>

        <Style x:Key="TitleTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>
    </Page.Resources>

    <Grid>
        <!--  InfoBar for Global Status Notifications  -->
        <InfoBar
            x:Name="StatusInfoBar"
            Margin="20"
            VerticalAlignment="Top"
            Canvas.ZIndex="100"
            IsOpen="{x:Bind ViewModel.StatusMessage, Mode=OneWay, Converter={StaticResource StringToBoolConverter}}"
            Message="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
            Severity="Informational" />

        <!--  1. NOT LOGGED IN STATE  -->
        <Grid Visibility="{x:Bind ViewModel.IsLoggedIn, Mode=OneWay, Converter={StaticResource InverseBoolToVisConverter}}">
            <Grid.Background>
                <!--  This would usually sit on top of your app background  -->
                <AcrylicBrush
                    FallbackColor="#202020"
                    TintColor="Black"
                    TintOpacity="0.6" />
            </Grid.Background>

            <Border
                Width="400"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                Style="{StaticResource GlassCardStyle}">
                <StackPanel Spacing="16">
                    <PersonPicture Height="80" DisplayName="{x:Bind ViewModel.LoginVM.Username, Mode=OneWay}" />

                    <TextBlock
                        HorizontalAlignment="Center"
                        Style="{StaticResource TitleTextStyle}"
                        Text="Dimmer Cloud" />

                    <TextBox Header="Username" Text="{x:Bind ViewModel.LoginVM.Username, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                    <PasswordBox Header="Password" Password="{x:Bind ViewModel.LoginVM.Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <Button
                        HorizontalAlignment="Stretch"
                        Command="{x:Bind ViewModel.LoginVM.LoginCommand}"
                        Content="Log In"
                        Style="{StaticResource AccentButtonStyle}" />

                    <StackPanel
                        HorizontalAlignment="Center"
                        Orientation="Horizontal"
                        Spacing="8">
                        <TextBlock
                            VerticalAlignment="Center"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Text="Don't have an account?" />
                        <HyperlinkButton Command="{x:Bind ViewModel.LoginVM.ToggleModeCommand}" Content="Sign Up" />
                    </StackPanel>

                    <ProgressBar IsIndeterminate="True" Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}" />
                </StackPanel>
            </Border>
        </Grid>

        <!--  2. LOGGED IN DASHBOARD  -->
        <Grid Padding="24" Visibility="{x:Bind ViewModel.IsLoggedIn, Mode=OneWay, Converter={StaticResource BoolToVisConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350" />
                <!--  Sidebar / Profile  -->
                <ColumnDefinition Width="24" />
                <!--  Spacer  -->
                <ColumnDefinition Width="*" />
                <!--  Main Content  -->
            </Grid.ColumnDefinitions>

            <!--  LEFT COLUMN: Profile & Devices  -->
            <StackPanel Grid.Column="0" Spacing="12">

                <!--  Profile Card  -->
                <Border Style="{StaticResource GlassCardStyle}">
                    <Grid ColumnDefinitions="Auto, *">
                        <PersonPicture
                            Width="60"
                            Height="60"
                            DisplayName="{x:Bind ViewModel.LoginVM.CurrentUser.Username, Mode=OneWay}" />
                        <StackPanel
                            Grid.Column="1"
                            Margin="12,0,0,0"
                            VerticalAlignment="Center">
                            <TextBlock
                                FontSize="18"
                                FontWeight="Bold"
                                Text="{x:Bind ViewModel.LoginVM.CurrentUser.Username, Mode=OneWay}" />
                            <TextBlock
                                FontSize="12"
                                Foreground="{ThemeResource SystemFillColorSuccessBrush}"
                                Text="Online" />
                            <HyperlinkButton
                                Margin="-4,4,0,0"
                                Command="{x:Bind ViewModel.LoginVM.LogoutCommand}"
                                Content="Log Out"
                                FontSize="12" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!--  Cloud Backup Card  -->
                <Border Style="{StaticResource GlassCardStyle}">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon FontSize="18" Glyph="&#xE753;" />
                            <!--  Cloud Icon  -->
                            <TextBlock FontWeight="SemiBold" Text="Cloud Sync" />
                        </StackPanel>
                        <TextBlock
                            FontSize="12"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Text="Backup your play history and settings."
                            TextWrapping="Wrap" />
                        <Button
                            HorizontalAlignment="Stretch"
                            Command="{x:Bind ViewModel.CreateCloudBackupCommand}"
                            Content="Backup Now" />
                    </StackPanel>
                </Border>

                <!--  Active Devices List  -->
                <Border VerticalAlignment="Stretch" Style="{StaticResource GlassCardStyle}">
                    <StackPanel Spacing="12">
                        <TextBlock FontWeight="SemiBold" Text="Nearby Devices" />

                        <ListView ItemsSource="{x:Bind ViewModel.OtherDevices, Mode=OneWay}" SelectionMode="None">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="modelsLive:UserDeviceSession">
                                    <Grid Margin="0,4" ColumnDefinitions="*, Auto">
                                        <StackPanel>
                                            <TextBlock FontWeight="Medium" Text="{x:Bind DeviceName}" />
                                            <TextBlock
                                                FontSize="11"
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                Text="{x:Bind DevicePlatform}" />
                                        </StackPanel>
                                        <Button
                                            Grid.Column="1"
                                            Command="{Binding DataContext.TransferSessionToDeviceCommand, ElementName=RootPage}"
                                            CommandParameter="{x:Bind}"
                                            Content="Transfer"
                                            FontSize="11" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!--  RIGHT COLUMN: Social & Chat  -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Style="{StaticResource TitleTextStyle}" Text="Social &amp; Chat" />

                <!--  Chat Interface Card  -->
                <Border
                    Grid.Row="1"
                    Padding="0"
                    Style="{StaticResource GlassCardStyle}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="250" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!--  Chat List (Friends)  -->
                        <Border BorderBrush="{ThemeResource CardBorderBrush}" BorderThickness="0,0,1,0">
                            <Grid RowDefinitions="Auto, *">
                                <AutoSuggestBox
                                    Margin="12"
                                    PlaceholderText="Search users..."
                                    QueryIcon="Find" />
                                <ListView Grid.Row="1" ItemsSource="{x:Bind ViewModel.SocialVM.Friends, Mode=OneWay}">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="modelsLive:UserModelOnline">
                                            <StackPanel
                                                Padding="8"
                                                Orientation="Horizontal"
                                                Spacing="12">
                                                <PersonPicture Height="32" DisplayName="{x:Bind Username}" />
                                                <TextBlock VerticalAlignment="Center" Text="{x:Bind Username}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </Grid>
                        </Border>

                        <!--  Active Conversation  -->
                        <Grid Grid.Column="1" Background="{ThemeResource LayerFillColorAltBrush}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!--  Chat Header  -->
                            <Border Padding="16,12" Background="{ThemeResource LayerFillColorDefaultBrush}">
                                <TextBlock FontWeight="SemiBold" Text="{x:Bind ViewModel.ChatVM.SelectedConversation.Name, Mode=OneWay, TargetNullValue='Select a chat'}" />
                            </Border>

                            <!--  Messages Area  -->
                            <ListView
                                Grid.Row="1"
                                Padding="16"
                                ItemsSource="{x:Bind ViewModel.ChatVM.Messages, Mode=OneWay}">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate x:DataType="modelsLive:ChatMessage">
                                        <!--  Message Bubble Logic via Converters usually needed here for alignment  -->
                                        <!--  Simplified for example: Left aligned  -->
                                        <Grid Margin="0,4">
                                            <Border
                                                MaxWidth="400"
                                                Padding="12,8"
                                                HorizontalAlignment="Left"
                                                Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                CornerRadius="16,16,16,0">
                                                <StackPanel>
                                                    <TextBlock
                                                        Foreground="White"
                                                        Text="{x:Bind Text}"
                                                        TextWrapping="Wrap" />
                                                    <!--  If Song Shared  -->
                                                    <StackPanel
                                                        Margin="0,8,0,0"
                                                        Padding="8"
                                                        Background="#20000000"
                                                        CornerRadius="8"
                                                        Visibility="{x:Bind MessageType, Converter={StaticResource StringMatchVisConverter}, ConverterParameter='SongShare'}">
                                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                                            <FontIcon Foreground="White" Glyph="&#xE8D6;" />
                                                            <TextBlock
                                                                FontWeight="Bold"
                                                                Foreground="White"
                                                                Text="Song Shared" />
                                                        </StackPanel>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                            <TextBlock
                                                Margin="0,0,0,-15"
                                                VerticalAlignment="Bottom"
                                                FontSize="10"
                                                Foreground="Gray"
                                                Text="{x:Bind UserName}" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>

                            <!--  Message Input  -->
                            <Grid
                                Grid.Row="2"
                                Padding="12"
                                Background="{ThemeResource LayerFillColorDefaultBrush}"
                                ColumnDefinitions="*, Auto, Auto">
                                <TextBox PlaceholderText="Type a message..." Text="{x:Bind ViewModel.ChatVM.NewMessageText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <Button
                                    Grid.Column="1"
                                    Margin="8,0,0,0"
                                    Command="{x:Bind ViewModel.ChatVM.ShareCurrentSongCommand}"
                                    Content="&#xE768;"
                                    FontFamily="Segoe MDL2 Assets"
                                    ToolTipService.ToolTip="Share Playing Song" />
                                <Button
                                    Grid.Column="2"
                                    Margin="8,0,0,0"
                                    Command="{x:Bind ViewModel.ChatVM.SendMessageCommand}"
                                    Content="Send"
                                    Style="{StaticResource AccentButtonStyle}" />
                            </Grid>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Page>