<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="Dimmer.WinUI.Views.WinuiPages.FeedbackDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:convertersWinUI="using:Dimmer.WinUI.Utils.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:Dimmer.WinUI.Views.WinuiPages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:Dimmer.DimmerLive.Models;assembly=Dimmer"
    mc:Ignorable="d">
    <Page.Resources>
        <ResourceDictionary>
            <convertersWinUI:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
            <convertersWinUI:BoolToInverseVisibilityConverter x:Key="BoolToInverseVisibilityConverter" />
            <convertersWinUI:StatusToColorConverter x:Key="StatusToColorConverter" />
            <convertersWinUI:TypeToColorConverter x:Key="TypeToColorConverter" />
            <convertersWinUI:UpvotedToColorConverter x:Key="UpvotedToColorConverter" />
            <convertersWinUI:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
            <convertersWinUI:DateTimeToRelativeConverter x:Key="DateTimeToRelativeConverter" />
        </ResourceDictionary>
    </Page.Resources>
    <ScrollViewer Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <StackPanel MaxWidth="900" Padding="20">
            <!-- Header -->
            <Button
                x:Name="BackBtn"
                Background="DarkSlateBlue"
                BorderBrush="DarkSlateBlue"
                Click="BackBtn_Click"
                Content="Back"
                CornerRadius="0,5,5,0" />

            <!-- Loading Indicator -->
            <ProgressRing
                Width="50"
                Height="50"
                Margin="0,50,0,0"
                HorizontalAlignment="Center"
                IsActive="{Binding IsLoading}"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}" />

            <!-- Issue Details -->
            <StackPanel Spacing="20" Visibility="{Binding IsLoading, Converter={StaticResource BoolToInverseVisibilityConverter}}">
                <!-- Issue Header Card -->
                <Border
                    Margin="0,20,0,0"
                    Padding="20"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="8"
                    Translation="0,0,12">
                    <Border.Shadow>
                        <ThemeShadow />
                    </Border.Shadow>
                    <StackPanel Spacing="15">
                        <!-- Title and Badges -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Grid.Column="0"
                                FontSize="28"
                                FontWeight="Bold"
                                Text="{Binding Issue.Title}"
                                TextWrapping="Wrap" />
                            <StackPanel Grid.Column="1" Spacing="5">
                                <Border
                                    Padding="10,5"
                                    Background="{Binding Issue.Status, Converter={StaticResource StatusToColorConverter}}"
                                    CornerRadius="4">
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="SemiBold"
                                        Foreground="White"
                                        Text="{Binding Issue.Status}" />
                                </Border>
                                <Border
                                    Padding="8,4"
                                    Background="{Binding Issue.Type, Converter={StaticResource TypeToColorConverter}}"
                                    CornerRadius="4">
                                    <TextBlock
                                        FontSize="11"
                                        FontWeight="SemiBold"
                                        Foreground="White"
                                        Text="{Binding Issue.Type}" />
                                </Border>
                            </StackPanel>
                        </Grid>

                        <!-- Meta Information -->
                        <StackPanel Orientation="Horizontal" Spacing="15">
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <FontIcon FontSize="14" Glyph="&#xE77B;" />
                                <TextBlock
                                    FontSize="14"
                                    Foreground="Gray"
                                    Text="{Binding Issue.AuthorUsername}" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <FontIcon FontSize="14" Glyph="&#xE7C1;" />
                                <TextBlock
                                    FontSize="14"
                                    Foreground="Gray"
                                    Text="{Binding Issue.Platform}" />
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Spacing="5">
                                <FontIcon FontSize="14" Glyph="&#xE946;" />
                                <TextBlock
                                    FontSize="14"
                                    Foreground="Gray"
                                    Text="{Binding Issue.AppVersion}" />
                            </StackPanel>
                        </StackPanel>

                        <!-- Description -->
                        <TextBlock
                            FontSize="15"
                            Text="{Binding Issue.Description}"
                            TextWrapping="Wrap" />

                        <!-- Actions -->
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <!-- Upvote Button -->
                            <Button Click="UpvoteButton_Click" IsEnabled="{Binding IsAuthenticated}">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <FontIcon
                                        FontSize="16"
                                        Foreground="{Binding HasUpvoted, Converter={StaticResource UpvotedToColorConverter}}"
                                        Glyph="&#xE74A;" />
                                    <TextBlock Text="{Binding Issue.UpvoteCount}" />
                                </StackPanel>
                            </Button>

                            <!-- Delete Button (only for author) -->
                            <Button
                                Click="DeleteIssueButton_Click"
                                Content="Delete"
                                Visibility="{Binding IsAuthor, Converter={StaticResource BoolToVisibilityConverter}}" />

                            <!-- Open GitHub -->
                            <Button Click="OpenGitHubButton_Click" Content="View on GitHub" />
                        </StackPanel>

                        <!-- Notification Settings (for authenticated users) -->
                        <StackPanel Spacing="10" Visibility="{Binding IsAuthenticated, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock
                                FontSize="14"
                                FontWeight="SemiBold"
                                Text="Notifications" />
                            <CheckBox
                                Content="Notify me when the status changes"
                                IsChecked="{Binding NotifyOnStatusChange, Mode=TwoWay}"
                                Unchecked="NotificationCheckBox_Changed"
                                Checked="NotificationCheckBox_Changed" />
                            <CheckBox
                                Content="Notify me about new comments"
                                IsChecked="{Binding NotifyOnComment, Mode=TwoWay}"
                                Unchecked="NotificationCheckBox_Changed"
                                Checked="NotificationCheckBox_Changed" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Comments Section -->
                <StackPanel Spacing="15">
                    <TextBlock
                        FontSize="22"
                        FontWeight="SemiBold"
                        Text="{Binding Issue.CommentCount, StringFormat='Comments ({0})'}" />

                    <!-- Add Comment (for authenticated users) -->
                    <Border
                        Padding="15"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Translation="0,0,12"
                        Visibility="{Binding IsAuthenticated, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Border.Shadow>
                            <ThemeShadow />
                        </Border.Shadow>
                        <StackPanel Spacing="10">
                            <TextBox
                                x:Name="CommentTextBox"
                                Height="100"
                                AcceptsReturn="True"
                                PlaceholderText="Add a comment..."
                                Text="{Binding NewCommentText, Mode=TwoWay}"
                                TextWrapping="Wrap" />
                            <Button
                                Click="AddCommentButton_Click"
                                Content="Post Comment"
                                IsEnabled="{Binding NewCommentText, Converter={StaticResource StringNotEmptyConverter}}"
                                Style="{StaticResource AccentButtonStyle}" />
                        </StackPanel>
                    </Border>

                    <!-- Comments List -->
                    <ItemsControl ItemsSource="{Binding Comments}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:FeedbackComment">
                                <Border
                                    Margin="0,0,0,10"
                                    Padding="15"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    CornerRadius="8"
                                    Translation="0,0,12">
                                    <Border.Shadow>
                                        <ThemeShadow />
                                    </Border.Shadow>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <!-- Comment Author and Time -->
                                        <StackPanel Grid.Row="0" Grid.Column="0">
                                            <TextBlock
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Text="{Binding AuthorUsername}" />
                                            <TextBlock
                                                FontSize="12"
                                                Foreground="Gray"
                                                Text="{Binding CreatedAt, Converter={StaticResource DateTimeToRelativeConverter}}" />
                                        </StackPanel>

                                        <!-- Delete Comment Button -->
                                        <Button
                                            Grid.Row="0"
                                            Grid.Column="1"
                                            Click="DeleteCommentButton_Click"
                                            Content="Delete"
                                            Tag="{Binding}" />

                                        <!-- Comment Text -->
                                        <TextBlock
                                            Grid.Row="1"
                                            Grid.Column="0"
                                            Grid.ColumnSpan="2"
                                            Margin="0,10,0,0"
                                            FontSize="14"
                                            Text="{Binding Text}"
                                            TextWrapping="Wrap" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</Page>
