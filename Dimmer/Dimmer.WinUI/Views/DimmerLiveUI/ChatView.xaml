<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Dimmer.WinUI.Views.DimmerLiveUI.ChatView"
             Title="ChatView"
             
                          xmlns:vm="clr-namespace:Dimmer.WinUI.ViewModel"
             x:DataType="vm:ChatViewModelWin"
              xmlns:converters="clr-namespace:Dimmer.Utilities.TypeConverters;assembly=Dimmer"
 xmlns:cw="clr-namespace:Dimmer.WinUI.Views.CustomViews"
 xmlns:lang="clr-namespace:Dimmer.Resources.Localization;assembly=Dimmer"
 xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
 xmlns:models="clr-namespace:Dimmer.Data.ModelView;assembly=Dimmer"
 xmlns:dimmSearch="clr-namespace:Dimmer.Data.ModelView.DimmerSearch;assembly=Dimmer"
 xmlns:modelsDb="clr-namespace:Dimmer.Data.Models;assembly=Dimmer"
 xmlns:modeltwo="clr-namespace:Dimmer.WinUI.Utils.Models"
             xmlns:modelOnline ="clr-namespace:Dimmer.DimmerLive.Models;assembly=Dimmer"
 xmlns:syncf="http://schemas.syncfusion.com/maui/toolkit"
 xmlns:chart="http://schemas.syncfusion.com/maui/toolkit"
 xmlns:tql="clr-namespace:Dimmer.DimmerSearch.TQL;assembly=Dimmer"
 xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
 xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
 xmlns:behv ="clr-namespace:CommunityToolkit.WinUI.Behaviors;assembly=CommunityToolkit.WinUI.Behaviors"
 xmlns:windows="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.WindowsSpecific;assembly=Microsoft.Maui.Controls"
 x:Name="myPage"
                 xmlns:device="clr-namespace:Microsoft.Maui.Devices;assembly=Microsoft.Maui.Essentials"
BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1F1F1F}"

Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <converters:DurationConverterFromMsToTimeSpan x:Key="DurationConverter" />
        <converters:BytesToMegabytesConverter x:Key="FileSizeConverter" />
        <converters:BytesArrayToImageSource x:Key="BytesToImageConverter" />
        <converters:BoolToInverseConverter x:Key="BoolToInverse" />
        <converters:IndexToVisibilityConverter x:Key="IndexToVisibilityConverter" />
        <converters:DateTimeToLocalDateConverter x:Key="DateTimeConverter" />
        <converters:DateTimeToLocalTimeConverter x:Key="DateTimeToTimeConverter" />
        <converters:BoolToYesNoConverter x:Key="BoolToYesNo" />
        <converters:VolumeConverter x:Key="VolConverter" />

    </ContentPage.Resources>

    <Grid ColumnDefinitions="250, *">

        <!-- Column 0: Conversation List -->
        <VerticalStackLayout Grid.Column="0" Spacing="5">
            <Label Text="Conversations" FontSize="Medium" Padding="10" FontAttributes="Bold" />
            <Button Text="General Chat" Command="{Binding GoToGeneralChatCommand}" Margin="5" />
            <Button Text="Note to Self"
        Command="{Binding StartNoteToSelfCommand}">
                
            </Button>
            <CollectionView ItemsSource="{Binding Conversations}"
                            SelectedItem="{Binding SelectedConversation}"
                            SelectionMode="Single">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="{x:Type modelOnline:ChatConversation}">
                        <Border Padding="10" Margin="5" StrokeShape="RoundRectangle 5">
                            <Label Text="{Binding Name}" />
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>

        <!-- Column 1: Message Area -->
        <Grid Grid.Column="1" RowDefinitions="auto,auto,*, Auto">
            <Grid Grid.Row="0">

                <VerticalStackLayout Grid.Row="0">
                    <Label Text="{Binding SelectedConversation.Name}" HorizontalTextAlignment="Center"
                       FontSize="40">

                    </Label>
                    <Label Text="{Binding Messages.Count}"/>
                    <Label Text="{Binding SessionTransferViewModel.StatusMessage}"/>
                    <Label Text="{Binding SessionTransferViewModel.OtherDevices[0].ObjectId}"/>
                    <Label Text="{Binding SessionTransferViewModel.OtherDevices[1].ObjectId}"/>
                    <Label Text="{Binding SessionTransferViewModel.OtherDevices[0].DeviceName}"/>
                    <Label Text="{Binding SessionTransferViewModel.OtherDevices[0].CreatedAt}"/>
                    <Label Text="{Binding SessionTransferViewModel.OtherDevices[1].DeviceName}"/>
                    <Label Text="{Binding SessionTransferViewModel.OtherDevices[1].CreatedAt}"/>
                </VerticalStackLayout>
            </Grid>
            <Grid Grid.Row="1" >
                <CollectionView ItemsSource="{Binding SessionTransferViewModel.OtherDevices}">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Span="3"
                                         Orientation="Horizontal"
                                         HorizontalItemSpacing="3"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="modelOnline:UserDeviceSession">
                            <Border StrokeThickness="1" Padding="10"
                                    Stroke="DarkSlateBlue"
                                    StrokeShape="RoundRectangle 20">
                                <VerticalStackLayout>
                                <Label Text="{Binding DeviceIdiom}"/>
                                <Label Text="{Binding DeviceName}"/>
                                <Label Text="{Binding DeviceOSVersion}"/>
                                    <Button x:Name="TransferSessionToDevice"
                                            Clicked="TransferSessionToDevice_Clicked"
                                            Text="Transfer"/>
                                </VerticalStackLayout>
                            </Border>

                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
            <CollectionView Grid.Row="2" ItemsSource="{Binding Messages}" 
                            Header="{Binding Messages.Count}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout ItemSpacing="10" Orientation="Vertical"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="{x:Type modelOnline:ChatMessage}">
                        <Border Padding="8" Margin="5" Stroke="DarkSlateBlue" StrokeShape="RoundRectangle 10">
                            <VerticalStackLayout>
                                <Label Text="{Binding UserName}" FontSize="Micro" FontAttributes="Bold" />
                                <Label Text="{Binding Text}" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Message Input Box -->
            <Grid Grid.Row="3" ColumnDefinitions="*, Auto" Padding="5" BackgroundColor="Transparent">
                <Entry Grid.Column="0" Placeholder="Type a message..." Text="{Binding NewMessageText}" ReturnType="Send" ReturnCommand="{Binding SendMessageCommand}"/>
                <HorizontalStackLayout Grid.Column="1" >
                    
                <Button Text="Send" Command="{Binding SendMessageCommand}" />
                <Button Text="Share Song" Command="{Binding OpenSessionTransferCommand}" />

                </HorizontalStackLayout>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>